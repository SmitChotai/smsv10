<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f9ff;
            margin: 0;
            padding: 30px;
            color: #2c3e50;
            text-align: center;
            line-height: 1.6;
        }

        h2 {
            color: #1a5276;
            margin-bottom: 10px;
            font-size: 28px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        #studentEmail {
            font-size: 1rem;
            margin-bottom: 25px;
            color: #566573;
            background-color: #e3f2fd;
            padding: 8px 15px;
            border-radius: 5px;
            display: inline-block;
        }

        h3 {
            color: #2e86c1;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 1px dashed #d6eaf8;
            padding-bottom: 8px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        table {
            width: 90%;
            max-width: 900px;
            margin: 0 auto 30px;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background-color: #2980b9;
            color: white;
        }

        th,
        td {
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            font-size: 15px;
            text-align: left;
        }

        th:last-child,
        td:last-child {
            text-align: right;
        }

        tbody tr:hover {
            background-color: #f2f9ff;
        }

        #overallAttendance {
            font-weight: bold;
            color: #27ae60;
            font-size: 1.5rem;
            display: block;
            margin: 15px auto 0;
            background-color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-width: 300px;
        }

        button {
            padding: 12px 25px;
            background-color: #e74c3c;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
        }

        @keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            table {
                width: 100%;
            }

            th,
            td {
                padding: 10px;
                font-size: 14px;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #ccc;
                margin-bottom: 15px;
                border-radius: 8px;
                overflow: hidden;
            }

            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }

            td:before {
                position: absolute;
                top: 12px;
                left: 12px;
                width: 45%;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                content: attr(data-label);
            }

            td:nth-of-type(1):before {
                content: "Subject";
            }

            td:nth-of-type(2):before {
                content: "Type";
            }

            td:nth-of-type(3):before {
                content: "Present";
            }

            td:nth-of-type(4):before {
                content: "Total";
            }

            td:nth-of-type(5):before {
                content: "Attendance %";
            }
        }
    </style>
</head>

<body>
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modalCloseButton">&times;</span>
            <div class="modal-header" id="modalHeader">Message</div>
            <div class="modal-body" id="modalBody">Logged in!Time to stay on track.</div>
            <div class="modal-footer">
                <button id="modalOkButton">OK</button>
            </div>
        </div>
    </div>

    <h2>Welcome, Student!</h2>
    <p id="studentEmail"></p>

    <h3>Your Subject-wise Attendance </h3>
    <table>
        <thead>
            <tr>
                <th>Subject</th>
                <th>Type</th>
                <th>Present</th>
                <th>Total</th>
                <th>Attendance %</th>
            </tr>
        </thead>
        <tbody id="attendanceTable"></tbody>
    </table>

    <h3>Overall Attendance: <span id="overallAttendance">0%</span></h3>

    <div id="absenceDetails"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgXG-oIsLygIUwC4H5xUcduHqWa1Kba5w",
            authDomain: "studentattendancesystem-e3f6c.firebaseapp.com",
            projectId: "studentattendancesystem-e3f6c",
            storageBucket: "studentattendancesystem-e3f6c.appspot.com",
            messagingSenderId: "385675923275",
            appId: "1:385675923275:web:945301f83c5a7d182162ce",
            measurementId: "G-DM0VLMVNTM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const emailDisplay = document.getElementById("studentEmail");
        const attendanceTable = document.getElementById("attendanceTable");
        const overallDisplay = document.getElementById("overallAttendance");

        function showModal(header, body) {
            document.getElementById('modalHeader').textContent = header;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('messageModal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('messageModal').style.display = 'none'; }
        document.getElementById("modalCloseButton").addEventListener("click", closeModal);
        document.getElementById("modalOkButton").addEventListener("click", closeModal);

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showModal("Authentication Required", "Please log in.");
                window.location.href = "index.html";
                return;
            }

            const studentEmail = user.email;
            const studentUid = user.uid;
            emailDisplay.textContent = `Logged in as: ${studentEmail}`;

            try {
                const studentDoc = await getDoc(doc(db, "users", studentUid));
                if (!studentDoc.exists()) throw new Error("Student data not found");

                const studentData = studentDoc.data();
                const department = studentData.department || null;
                const semester = studentData.semester || null;

                if (!department || !semester) {
                    showModal("Error", "Your department or semester info is missing. Please contact admin.");
                    return;
                }

                const attendanceSnap = await getDocs(query(
                    collection(db, "attendance"),
                    where("studentId", "==", studentUid),
                    where("department", "==", department),
                    where("semester", "==", semester)
                ));

                const attendanceCounts = {}; // subject+type
                const combinedCounts = {};   // subject only
                const absenceDetails = [];

                let totalPresent = 0;
                let totalClasses = 0;

                attendanceSnap.forEach(doc => {
                    const record = doc.data();
                    const key = `${record.subject}__${record.type}`;

                    if (!attendanceCounts[key]) {
                        attendanceCounts[key] = { subject: record.subject, type: record.type, present: 0, total: 0 };
                    }

                    attendanceCounts[key].total++;
                    totalClasses++;
                    if (record.status === "Present") {
                        attendanceCounts[key].present++;
                        totalPresent++;
                    } else {
                        const dayName = new Date(record.date).toLocaleDateString("en-US", { weekday: "long" });
                        absenceDetails.push({
                            subject: record.subject,
                            type: record.type,
                            date: record.date,
                            time: record.time || "N/A",
                            day: dayName
                        });
                    }

                    // Combined by subject
                    if (!combinedCounts[record.subject]) {
                        combinedCounts[record.subject] = { subject: record.subject, present: 0, total: 0 };
                    }
                    combinedCounts[record.subject].total++;
                    if (record.status === "Present") combinedCounts[record.subject].present++;
                });

                // --- Populate Lecture/Lab separate table ---
                attendanceTable.innerHTML = "";
                for (const key in attendanceCounts) {
                    const { subject, type, present, total } = attendanceCounts[key];
                    const percentage = total === 0 ? 0 : ((present / total) * 100).toFixed(1);

                    let note;
                    if (total === 0) {
                        note = `<span style='color:gray'>No data</span>`;
                    } else if ((present / total) >= 0.70) {
                        note = `<span style='color:green'>On track</span>`;
                    } else {
                        const neededLectures = Math.ceil((0.70 * total - present) / 0.25);
                        note = `<span style='color:red'>Need ${neededLectures} more </span>`;
                    }

                    attendanceTable.innerHTML += `
        <tr>
            <td data-label="Subject">${subject}</td>
            <td data-label="Type">${type}</td>
            <td data-label="Present">${present}</td>
            <td data-label="Total">${total}</td>
            <td data-label="Attendance %">${percentage}%<br>${note}</td>
        </tr>`;
                }


                // --- Show Combined Subject Table ---
                const combinedTitle = document.createElement("h3");
                combinedTitle.textContent = "📊 Combined Subject Attendance (Lecture + Lab)";
                document.body.appendChild(combinedTitle);

                const combinedTable = document.createElement("table");
                combinedTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Present</th>
                            <th>Total</th>
                            <th>Attendance %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(combinedCounts).map(d => {
                    const percent = d.total === 0 ? 0 : ((d.present / d.total) * 100).toFixed(1);

                    let note;
                    if (d.total === 0) {
                        note = `<span style='color:gray'>No data</span>`;
                    } else if ((d.present / d.total) >= 0.70) {
                        note = `<span style='color:green'>On track</span>`;
                    } else {
                        // Formula: n ≥ (0.70*total - present) / 0.25
                        const neededLectures = Math.ceil((0.70 * d.total - d.present) / 0.25);
                        note = `<span style='color:red'>Need ${neededLectures} more </span>`;
                    }

                    return `
        <tr>
            <td>${d.subject}</td>
            <td>${d.present}</td>
            <td>${d.total}</td>
            <td>${percent}%<br>${note}</td>
        </tr>`;
                }).join("")}

                    </tbody>`;
                document.body.appendChild(combinedTable);

                // --- Overall Attendance ---
                const overallPercent = totalClasses === 0 ? 0 : ((totalPresent / totalClasses) * 100).toFixed(2);
                overallDisplay.textContent = `${overallPercent}%`;

                // --- Absence Records ---
                if (absenceDetails.length > 0) {
                    const absTitle = document.createElement("h3");
                    absTitle.textContent = "🟥 Absence Records";
                    document.body.appendChild(absTitle);

                    const absTable = document.createElement("table");
                    absTable.innerHTML = `
                        <thead><tr><th>Subject</th><th>Type</th><th>Date</th><th>Day</th><th>Time</th></tr></thead>
                        <tbody>
                            ${absenceDetails.map(d => `
                                <tr>
                                    <td>${d.subject}</td>
                                    <td>${d.type}</td>
                                    <td>${d.date}</td>
                                    <td>${d.day}</td>
                                    <td>${d.time}</td>
                                </tr>`).join("")}
                        </tbody>`;
                    document.body.appendChild(absTable);
                }

                // --- Logout Button ---
                const logoutBtnContainer = document.createElement("div");
                logoutBtnContainer.style.textAlign = "center";
                logoutBtnContainer.style.margin = "50px 0 30px 0";
                logoutBtnContainer.innerHTML = `<button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>`;
                document.body.appendChild(logoutBtnContainer);

                document.getElementById("logoutBtn").addEventListener("click", async () => {
                    try {
                        await signOut(auth);
                        window.location.href = "index.html";
                    } catch (error) {
                        console.error("Error logging out:", error);
                        showModal("Error", "Error logging out: " + error.message);
                    }
                });

            } catch (err) {
                console.error("Error loading student dashboard:", err);
                showModal("Error", err.message || "Failed to load dashboard.");
            }
        });
    </script>
</body>

</html>
