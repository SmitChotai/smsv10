<!DOCTYPE html>
<html lang="en">

<head>
    Â  Â 
    <meta charset="UTF-8">
    Â  Â 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    Â  Â  <title>Teacher - Mark Attendance</title>
    Â  Â 
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    Â  Â  <style>
        /* Teacher Dashboard Styles */
        body {
            font-family: 'Inter', sans-serif;
            /* Using Inter as requested */
            background-color: #f5f9fc;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
            max-width: 1200px;
            margin: 0 auto;
            line-height: 1.6;
        }

        h2 {
            color: #1a5276;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 28px;
        }

        #teacherEmailDisplay {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 500;
            color: #1a5276;
        }

        label {
            display: block;
            margin: 15px 0 8px 0;
            font-weight: 600;
            color: #2c3e50;
        }

        select,
        input[type="date"],
        input[type="text"] {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #d6eaf8;
            border-radius: 6px;
            background-color: white;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232980b9'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            appearance: none;
            padding-right: 40px;
        }

        select:focus,
        input[type="date"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Added shadow */
        }

        button:hover {
            background-color: #1a5276;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            /* Increased shadow on hover */
        }

        #loadBtn {
            background-color: #27ae60;
            margin-top: 20px;
        }

        #loadBtn:hover {
            background-color: #219653;
        }

        #submitBtn {
            background-color: #2ecc71;
            margin-top: 30px;
            padding: 14px 24px;
            font-size: 17px;
        }

        #submitBtn:hover {
            background-color: #27ae60;
        }

        /* Attendance Form Styles */
        #attendanceForm {
            margin: 30px 0;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .attendance-actions button {
            padding: 10px 15px;
            font-size: 14px;
            box-shadow: none;
            /* Remove shadow for these smaller buttons */
        }

        .attendance-actions button:hover {
            transform: none;
            /* Remove transform for these smaller buttons */
            box-shadow: none;
        }


        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px 18px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Logout Button */
        #logoutBtn {
            background-color: #e74c3c;
            margin-left: 15px;
        }

        #logoutBtn:hover {
            background-color: #c0392b;
        }

        /* Missing Attendance Section */
        #missingAttendanceSection {
            background-color: #fff3cd;
            /* Light yellow background */
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        #missingAttendanceSection h3 {
            color: #856404;
            /* Darker yellow text */
            margin-top: 0;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #missingAttendanceList {
            list-style: none;
            padding: 0;
        }

        #missingAttendanceList li {
            padding: 8px 0;
            border-bottom: 1px dashed #ffeec4;
            color: #856404;
        }

        #missingAttendanceList li:last-child {
            border-bottom: none;
        }

        /* Attendance View Section */
        #attendanceViewSection {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-top: 40px;
        }

        #attendanceViewSection h3 {
            color: #1a5276;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 24px;
        }

        #attendanceViewFilters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        #attendanceViewFilters>div {
            flex: 1 1 200px;
            /* Allow items to grow and shrink */
        }

        #attendanceViewResults table {
            margin-top: 20px;
        }

        /* Modal for messages instead of alert() */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
        }

        @keyframes animatetop {
            from {
                top: -300px;
                opacity: 0
            }

            to {
                top: 0;
                opacity: 1
            }
        }

        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .modal-body {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-footer {
            text-align: right;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            /* Hide table headers (but not display: none;, for accessibility) */
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #ccc;
                margin-bottom: 15px;
            }

            td {
                /* Behave like a "row" */
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }

            td:before {
                /* Now like a table header */
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }

            /* Label the data */
            td:nth-of-type(1):before {
                content: "Enroll No";
            }

            td:nth-of-type(2):before {
                content: "Name";
            }

            td:nth-of-type(3):before {
                content: "Present";
            }

            td:nth-of-type(4):before {
                content: "Absent";
            }

            #attendanceViewFilters {
                flex-direction: column;
            }

            select,
            input[type="date"],
            input[type="text"] {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    Â  Â  <div id="messageModal" class="modal">
        Â  Â  Â  Â  <div class="modal-content">
            Â  Â  Â  Â  Â  Â  <span class="close-button" id="modalCloseButton">&times;</span>
            Â  Â  Â  Â  Â  Â  <div class="modal-header" id="modalHeader">Message</div>
            Â  Â  Â  Â  Â  Â  <div class="modal-body" id="modalBody"></div>
            Â  Â  Â  Â  Â  Â  <div class="modal-footer">
                Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalOkButton">OK</button>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  </div>
        Â  Â  </div>

    Â  Â  <h2>Teacher Dashboard</h2>
    Â  Â  <p id="teacherEmailDisplay"></p>

    Â  Â  <label for="department">Department:</label>
    Â  Â  <select id="department">
        Â  Â  Â  Â  <option value="CSE">CSE</option>
        Â  Â  Â  Â  <option value="IT">IT</option>
        Â  Â  Â  Â  <option value="CE">CE</option>
        Â  Â  </select>

    Â  Â  <label for="semester">Semester:</label>
    Â  Â  <select id="semester">
        Â  Â  Â  Â  <option value="1">1</option>
        Â  Â  Â  Â  <option value="2">2</option>
        Â  Â  Â  Â  <option value="3">3</option>
        Â  Â  Â  Â  <option value="4">4</option>
        Â  Â  Â  Â  <option value="5">5</option>
        Â  Â  Â  Â  <option value="6">6</option>
        Â  Â  </select>

    Â  Â  <label for="subjectSelect">Subject:</label>
    Â  Â  <select id="subjectSelect"></select>

    Â  Â  <label for="classType">Type:</label>
    Â  Â  <select id="classType">
        Â  Â  Â  Â  <option value="Lecture">Lecture</option>
        Â  Â  Â  Â  <option value="Lab">Lab</option>
        Â  Â  </select>
            <label for="labSectionSelect" id="labSectionLabel" style="display:none;">Lab Section:</label>
    <select id="labSectionSelect" style="display:none;">
    <option value="A">CSE -1 </option>
    <option value="B">CSE -2</option>
    </select>
    Â  Â  <label for="attendanceDate">Date:</label>
    Â  Â  <input type="date" id="attendanceDate" />

    Â  Â  <button id="downloadAttendanceBtn" style="background-color: #3498db;"><i class="fas fa-download"></i> Download
        Â  Â  Â  Â  Attendance</button>
    Â  Â  <button id="downloadSummary">Download Attendance Summary</button>

    Â  Â  <br><br>
    Â  Â  <button id="loadBtn"><i class="fas fa-users"></i> Load Students</button>

    Â  Â  <div id="missingAttendanceSection">
        Â  Â  Â  Â  <h3><i class="fas fa-exclamation-triangle"></i> Unmarked Classes for this Week</h3>
        Â  Â  Â  Â  <ul id="missingAttendanceList">
            Â  Â  Â  Â  Â  Â  <li>No missing attendance to show for selected criteria.</li>
            Â  Â  Â  Â  </ul>
        Â  Â  </div>

    Â  Â  <form id="attendanceForm">
        Â  Â  Â  Â  <div class="attendance-actions">
            Â  Â  Â  Â  Â  Â  <button type="button" id="markAllPresentBtn" style="background-color: #28a745;"><i Â  Â  Â  Â  Â  Â  Â 
                    Â  Â  Â  class="fas fa-check-double"></i> Mark All Present</button>
            Â  Â  Â  Â  Â  Â  <button type="button" id="markAllAbsentBtn" style="background-color: #dc3545;"><i Â  Â  Â  Â  Â  Â  Â 
                    Â  Â  Â  class="fas fa-times-circle"></i> Mark All Absent</button>
            Â  Â  Â  Â  </div>
        Â  Â  </form>

    Â  Â  <button id="submitBtn"><i class="fas fa-save"></i> Submit Attendance</button>

    Â  Â  <div id="attendanceViewSection">
        Â  Â  Â  Â  <h3><i class="fas fa-chart-bar"></i> View Attendance Records</h3>
        Â  Â  Â  Â  <div id="attendanceViewFilters">
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewDepartment">Department:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <select id="viewDepartment">
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">All</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CSE">CSE</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="IT">IT</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="CE">CE</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  </select>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewSemester">Semester:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <select id="viewSemester">
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">All</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="1">1</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="2">2</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="3">3</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="4">4</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="5">5</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="6">6</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  </select>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewSubject">Subject:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <select id="viewSubject">
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">All</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Populated dynamically -->
                    Â  Â  Â  Â  Â  Â  Â  Â  </select>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewType">Type:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <select id="viewType">
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">All</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Lecture">Lecture</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Lab">Lab</option>
                    Â  Â  Â  Â  Â  Â  Â  Â  </select>
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewStudentSearch">Student Name/Enroll No:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="viewStudentSearch" placeholder="Optional search">
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <div>
                Â  Â  Â  Â  Â  Â  Â  Â  <label for="viewMonth">Month:</label>
                Â  Â  Â  Â  Â  Â  Â  Â  <input type="month" id="viewMonth">
                Â  Â  Â  Â  Â  Â  </div>
            Â  Â  Â  Â  Â  Â  <button id="viewAttendanceBtn" style="background-color: #007bff;"><i class="fas fa-search"></i>
                View
                Â  Â  Â  Â  Â  Â  Â  Â  Records</button>
            Â  Â  Â  Â  </div>
        Â  Â  Â  Â  <div id="attendanceViewResults">
            Â  Â  Â  Â  Â  Â  <!-- Attendance results table will be loaded here -->
            Â  Â  Â  Â  Â  Â  <p>Select filters and click "View Records" to see attendance.</p>
            Â  Â  Â  Â  </div>
        Â  Â  </div>
    Â  Â  <!-- <div id="studentSummarySection"
Â  Â  Â  Â  style="margin-top: 40px; background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
Â  Â  Â  Â  <h3><i class="fas fa-user-check"></i> Student Attendance Summary(Under Construction)</h3>
Â  Â  Â  Â  <label for="summaryEnroll">Enter Enroll No:</label>
Â  Â  Â  Â  <input type="text" id="summaryEnroll" placeholder="Enter Enroll No">
Â  Â  Â  Â  <label for="summaryStartDate">Start Date:</label>
Â  Â  Â  Â  <input type="date" id="summaryStartDate">
Â  Â  Â  Â  <label for="summaryEndDate">End Date:</label>
Â  Â  Â  Â  <input type="date" id="summaryEndDate">
Â  Â  Â  Â  <button id="summaryBtn" style="background-color: #8e44ad;"><i class="fas fa-search"></i> Get Summary</button>
Â  Â  Â  Â  <div id="summaryResult" style="margin-top: 20px;"></div>
Â  Â  </div> -->
    Â  Â  <h2>ðŸ“Š Student Attendance Summary</h2>
    Â  Â  <div>
        Â  Â  Â  Â  <label>Enter Enroll No:</label>
        Â  Â  Â  Â  <input type="text" id="summaryEnrollNo" />
        Â  Â  Â  Â  <label>Start Date:</label>
        Â  Â  Â  Â  <input type="date" id="summaryStartDate" value="2025-06-09" />
        Â  Â  Â  Â  <label>End Date:</label>
        Â  Â  Â  Â  <input type="date" id="summaryEndDate" />
        Â  Â  Â  Â  <button id="getSummaryBtn">Get Summary</button>
        Â  Â  </div>

    Â  Â  <p>Total Classes: <span id="totalClasses">0</span></p>
    Â  Â  <p>Present: <span id="presentCount">0</span></p>
    Â  Â  <p>Absent: <span id="absentCount">0</span></p>
    Â  Â  <p>Attendance %: <span id="attendancePercent">0.00%</span></p>

    Â  Â 
    <hr>
    Â  Â  <h2>ðŸ“¥ Download Attendance Sheet</h2>
    Â  Â  <button id="downloadCsv">Download Attendance (CSV)</button>

    Â  Â  <p>Total Classes: <span id="totalClasses">0</span></p>
    Â  Â  <p>Present: <span id="presentCount">0</span></p>
    Â  Â  <p>Absent: <span id="absentCount">0</span></p>
    Â  Â  <p>Attendance %: <span id="attendancePercent">0.00%</span></p>

    Â  Â  <!-- âœ… Insert below the summary section -->
    Â  Â  <div id="editAttendanceSection" Â  Â  Â  Â 
        style="margin-top: 40px; background-color: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        Â  Â  Â  Â  <h3><i class="fas fa-edit"></i> Edit Student Attendance(Under Construction)</h3>
        Â  Â  Â  Â  <label for="editEnroll">Enter Enroll No:</label>
        Â  Â  Â  Â  <input type="text" id="editEnroll" placeholder="Enter Enroll No">
        Â  Â  Â  Â  <label for="editStartDate">Start Date:</label>
        Â  Â  Â  Â  <input type="date" id="editStartDate">
        Â  Â  Â  Â  <label for="editEndDate">End Date:</label>
        Â  Â  Â  Â  <input type="date" id="editEndDate">
        Â  Â  Â  Â  <button id="editSearchBtn" style="background-color: #e67e22;"><i class="fas fa-search"></i> Search
            Â  Â  Â  Â  Â  Â  Attendance</button>
        Â  Â  Â  Â  <div id="editResults" style="margin-top: 20px;"></div>
        Â  Â  </div>

    Â  Â  <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
        Â  Â  Â  Â  <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        Â  Â  </div>

</body>

</html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        setDoc,
        doc,
        orderBy,
        getDoc,
        writeBatch // Import writeBatch for efficient writes
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut,
        signInWithCustomToken, // Ensure this is imported for Canvas setup
        signInAnonymously // Ensure this is imported for Canvas setup
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Canvas Environment Variables ---
    // MANDATORY: Use __app_id, __firebase_config, __initial_auth_token
    // Note: These variables are provided by the Canvas environment.
    // The fallback is for local development where they might not be defined.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        // Fallback for local testing if __firebase_config is not defined
        apiKey: "AIzaSyBgXG-oIsLygIUwC4H5xUcduHqWa1Kba5w",
        authDomain: "studentattendancesystem-e3f6c.firebaseapp.com",
        projectId: "studentattendancesystem-e3f6c",
        storageBucket: "studentattendancesystem-e3f6c.appspot.com",
        messagingSenderId: "385675923275",
        appId: "1:385675923275:web:945301f83c5a7d182162ce",
        measurementId: "G-DM0VLMVNTM"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global variables
    let currentTeacherId = null;
    const teacherEmailDisplay = document.getElementById("teacherEmailDisplay");
    const departmentSelect = document.getElementById("department");
    const semesterSelect = document.getElementById("semester");
    const subjectSelect = document.getElementById("subjectSelect");
    const attendanceDateInput = document.getElementById("attendanceDate");
    const classTypeSelect = document.getElementById("classType");
    const attendanceForm = document.getElementById("attendanceForm");
  const labSectionSelect = document.getElementById("labSectionSelect");
  const labSectionLabel = document.getElementById("labSectionLabel");

    let weeklyAssignments = []; // Stores all assignments for the current teacher, dept, sem for the week
    let studentDataMap = {}; // Stores student data fetched by loadStudents for easy lookup by ID
    let allStudents = []; // To store all students for the "View Attendance" student search dropdown

    // --- Modal Functions (Instead of alert()) ---
    function showModal(header, body) {
        document.getElementById('modalHeader').textContent = header;
        document.getElementById('modalBody').textContent = body;
        document.getElementById('messageModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('messageModal').style.display = 'none';
    }

    // --- Authentication State Listener ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // Attempt to sign in with custom token first (Canvas environment)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("DEBUG Teacher: Signed in with custom token.");
                    // The onAuthStateChanged listener will re-fire with the authenticated user
                    return;
                } catch (error) {
                    console.error("DEBUG Teacher: Error signing in with custom token:", error);
                    showModal("Authentication Error", "Failed to authenticate. Please log in again.");
                    window.location.href = "index.html"; // Redirect to login on error
                    return;
                }
            } else {
                // Fallback to anonymous sign-in for local development/testing without token
                try {
                    await signInAnonymously(auth);
                    console.log("DEBUG Teacher: Signed in anonymously.");
                    // The onAuthStateChanged listener will re-fire with the authenticated user
                    return;
                } catch (error) {
                    console.error("DEBUG Teacher: Error signing in anonymously:", error);
                    showModal("Authentication Error", "Failed to sign in anonymously. Please log in.");
                    window.location.href = "index.html";
                    return;
                }
            }
        }

        // After successful authentication, check user role in Firestore
        // MODIFIED: Changed path to root-level 'users'
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);

        if (!userDocSnap.exists() || userDocSnap.data().role !== "teacher") {
            showModal("Access Denied", "You do not have teacher privileges.");
            await signOut(auth); // Sign out unauthorized user
            window.location.href = "index.html";
            return;
        }

        currentTeacherId = user.uid;
        teacherEmailDisplay.textContent = `Logged in as: ${user.email}`;

        // Load initial subjects based on current selections
        await loadAssignedSubjects();
        await loadAllStudents(); // Load all students for the view attendance section
        updateDatePickerRestrictions(); // Set date picker min/max based on assignments
        checkAndHighlightMissingAttendance(); // Check for missing attendance on load
        populateViewSubjectDropdown(); // Populate subject dropdown for viewing section
    });

    // --- Function to Load Assigned Subjects for the Teacher ---
    async function loadAssignedSubjects() {
        subjectSelect.innerHTML = ""; // Clear existing options
        const dept = departmentSelect.value;
        const sem = semesterSelect.value;

        console.log("DEBUG Teacher: Attempting to load subjects for:", { dept, sem, teacher: currentTeacherId });

        // MODIFIED: Changed path to root-level 'assignments'
        const q = query(collection(db, "assignments"),
            where("teacherId", "==", currentTeacherId),
            where("department", "==", dept),
            where("semester", "==", sem)
        );

        try {
            const snapshot = await getDocs(q);
            weeklyAssignments = []; // Reset weekly assignments array before populating

            if (snapshot.empty) {
                const option = document.createElement("option");
                option.value = "";
                option.textContent = `No subjects assigned for this selection.`;
                subjectSelect.appendChild(option);
                subjectSelect.disabled = true; // Disable subject selection if no assignments
                console.log("DEBUG Teacher: No subjects found for current criteria.");
                return;
            }

            subjectSelect.disabled = false; // Enable subject selection
            snapshot.forEach(doc => {
                const data = doc.data();
                weeklyAssignments.push(data); // Store all fetched assignments for date validation
                const option = document.createElement("option");
                // Combine subject, type, time, and assigned days into the option's value
                option.value = `${data.subject}__${data.type}__${data.time}__${data.days.join(',')}`;
                option.textContent = `${data.subject} (${data.type}) - ${data.time} (${data.days.join(', ')})`;
                subjectSelect.appendChild(option);
            });
            console.log("DEBUG Teacher: Successfully fetched and processed assignments:", weeklyAssignments);

            // After loading subjects, always update date picker restrictions and check for missing attendance
            updateDatePickerRestrictions();
            checkAndHighlightMissingAttendance();
            populateViewSubjectDropdown(); // Update view subjects when assignments change
        } catch (error) {
            console.error("DEBUG Teacher: Detailed error loading assigned subjects:", error);
            subjectSelect.innerHTML = "<option value=''>Error loading subjects</option>";
            subjectSelect.disabled = true;
            showModal("Error", "Error loading subjects: " + error.message);
        }
    }

    // --- Date Utility Functions ---
    // Formats a Date object to "YYYY-MM-DD" string
    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        const year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }

    // Gets a specific day (0=Sun, 1=Mon...6=Sat) in the week of a given date
    function getDayInWeek(date, dayIndex) {
        const d = new Date(date);
        const day = d.getDay(); // Current day of the week (0 for Sunday)
        const diff = d.getDate() - day + dayIndex;
        const result = new Date(d.setDate(diff));
        return new Date(result.setHours(0, 0, 0, 0)); // Normalize to start of day
    }

    // --- Date Picker Restrictions Logic ---
    function updateDatePickerRestrictions() {
        // For "any day except Sunday" logic, we remove min/max constraints from the HTML date input.
        // The validation will happen in validateSelectedDateAgainstAssignments.
        attendanceDateInput.removeAttribute('min');
        attendanceDateInput.removeAttribute('max');

        // Ensure the change listener is always active to validate selected date
        attendanceDateInput.removeEventListener('change', validateSelectedDateAgainstAssignments);
        attendanceDateInput.addEventListener('change', validateSelectedDateAgainstAssignments);
    }

    // Validates the selected date against the "no Sundays" rule and assigned classes
    async function validateSelectedDateAgainstAssignments() {
        const selectedDateStr = attendanceDateInput.value;
        if (!selectedDateStr) {
            // If date input is empty, no validation needed yet
            return;
        }

        const selectedDate = new Date(selectedDateStr + 'T00:00:00'); // Ensure consistent date parsing
        const selectedDayName = getDayName(selectedDateStr); // Use the helper to get the day name

        // 1. First, check if it's a Sunday
        if (selectedDayName === 'Sunday') {
            showModal("Invalid Date", "Attendance cannot be marked on Sundays. Please select another date.");
            attendanceDateInput.value = ''; // Clear the input
            console.log("DEBUG Teacher: Sunday selected. Date cleared.");
            return; // Stop further validation
        }

        // 2. Then, check if there's an assignment for the selected subject/type on this day
        const selectedSubjectOption = subjectSelect.value;
        if (!selectedSubjectOption) {
            // If no subject is selected, we can't validate against assignments yet.
            // The Sunday check is already done.
            return;
        }

        // NEW: Parse the JSON string from subjectSelect.value
        let selectedSubjectData;
        try {
            selectedSubjectData = JSON.parse(selectedSubjectOption);
        } catch (e) {
            console.error("DEBUG Teacher: Error parsing subject select value in validation. Ensure loadAssignedSubjects is updated.", e);
            showModal("Configuration Error", "Please refresh the page. There's an issue with subject selection data.");
            return;
        }
        const currentSubject = selectedSubjectData.subject;
        const currentType = selectedSubjectData.type;
        const assignedDaysForSubject = selectedSubjectData.days; // Get assigned days directly

        // Update the condition to use assignedDaysForSubject directly
        const hasAssignmentOnSelectedDay = assignedDaysForSubject.includes(selectedDayName);

        if (!hasAssignmentOnSelectedDay) {
            showModal("Invalid Date Selection", `No classes for ${currentSubject} (${currentType}) are assigned on ${selectedDayName}. Please select a day with assigned classes.`);
            attendanceDateInput.value = ''; // Clear selection if invalid
            console.log(`DEBUG Teacher: Invalid date (${selectedDayName}) selected: No assignments found for this day.`);
        }
    }
    // --- Function to Check and Highlight Missing Attendance ---
    async function checkAndHighlightMissingAttendance() {
        const missingList = document.getElementById("missingAttendanceList");
        missingList.innerHTML = ''; // Clear previous list

        const dept = departmentSelect.value;
        const sem = semesterSelect.value;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday

        let checkStartDate, checkEndDate;

        if (dayOfWeek === 0) { // If today is Sunday
            checkStartDate = getDayInWeek(today, 0);
            checkStartDate.setDate(checkStartDate.getDate() - 7); // Previous Sunday
            checkEndDate = new Date(checkStartDate);
            checkEndDate.setDate(checkStartDate.getDate() + 6); // Previous Saturday
        } else { // If Monday-Saturday
            checkStartDate = getDayInWeek(today, 1); // Current Monday
            checkEndDate = today;
        }

        console.log(`DEBUG Teacher: Checking for missing attendance from ${formatDate(checkStartDate)} to ${formatDate(checkEndDate)}.`);

        const scheduledClasses = [];
        weeklyAssignments.forEach(assignment => {
            for (let d = new Date(checkStartDate); d <= checkEndDate; d.setDate(d.getDate() + 1)) {
                const dayName = d.toLocaleString('en-US', { weekday: 'long' });
                if (assignment.days.includes(dayName)) {
                    scheduledClasses.push({
                        date: formatDate(d),
                        subject: assignment.subject,
                        type: assignment.type,
                        time: assignment.time,
                        dayName: dayName
                    });
                }
            }
        });

        if (scheduledClasses.length === 0) {
            const li = document.createElement("li");
            li.textContent = "No classes scheduled for this period or selection.";
            missingList.appendChild(li);
            return;
        }

        // MODIFIED: Changed path to root-level 'attendance'
        const attendanceQuery = query(
            collection(db, "attendance"),
            where("teacherId", "==", currentTeacherId),
            where("department", "==", dept),
            where("semester", "==", sem),
        );

        const attendanceSnapshot = await getDocs(attendanceQuery);
        const markedAttendance = new Set(); // To store unique identifiers of marked classes

        attendanceSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            const recordDate = new Date(data.date);
            recordDate.setHours(0, 0, 0, 0);

            // Filter by date range in memory
            if (recordDate >= checkStartDate && recordDate <= checkEndDate) {
                const identifier = `${data.date}__${data.subject}__${data.type}__${data.time}`;
                markedAttendance.add(identifier);
            }
        });

        let foundMissing = false;
        scheduledClasses.forEach(scheduledClass => {
            const identifier = `${scheduledClass.date}__${scheduledClass.subject}__${scheduledClass.type}__${scheduledClass.time}`;
            if (!markedAttendance.has(identifier)) {
                foundMissing = true;
                const li = document.createElement("li");
                li.innerHTML = `<strong>${scheduledClass.date} (${scheduledClass.dayName})</strong>: ${scheduledClass.subject} (${scheduledClass.type}) at ${scheduledClass.time} - <span style="color:red;">UNMARKED</span>`;
                missingList.appendChild(li);
            }
        });

        if (!foundMissing) {
            const li = document.createElement("li");
            li.textContent = "All scheduled classes for this period have attendance marked!";
            missingList.appendChild(li);
        }
    }


    // --- Function to Load Students into the Form ---
    async function loadStudents() {
    const department = departmentSelect.value;
    const semester = semesterSelect.value;
    const form = document.getElementById("attendanceForm");

    form.innerHTML = `
        <div class="attendance-actions">
            <button type="button" id="markAllPresentBtn" style="background-color: #28a745;">
                <i class="fas fa-check-double"></i> Mark All Present
            </button>
            <button type="button" id="markAllAbsentBtn" style="background-color: #dc3545;">
                <i class="fas fa-times-circle"></i> Mark All Absent
            </button>
        </div>
    `;

    document.getElementById("markAllPresentBtn").addEventListener("click", markAllPresent);
    document.getElementById("markAllAbsentBtn").addEventListener("click", markAllAbsent);

    const selectedSubjectInfo = subjectSelect.value.split("__");
    if (!selectedSubjectInfo[0] || !attendanceDateInput.value) {
        showModal("Selection Required", "Please select a Subject and a Date before loading students.");
        console.log("DEBUG Teacher: Pre-validation failed: Subject or Date not selected.");
        return;
    }

    studentDataMap = {};

    console.log("DEBUG Teacher: Attempting to load students for Dept:", department, "Sem:", semester);

    try {
        const q = query(
            collection(db, "users"),
            where("role", "==", "student"),
            where("department", "==", department),
            where("semester", "==", semester),
            orderBy("enrollno")
        );

        const snapshot = await getDocs(q);

        if (snapshot.empty) {
            const noStudentsMessage = document.createElement("p");
            noStudentsMessage.textContent = `No students found for selected department (${department}) & semester (${semester}).`;
            form.appendChild(noStudentsMessage);
            console.log("DEBUG Teacher: No students found.");
            return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
            <tr>
                <th>Enroll No</th>
                <th>Name</th>
                <th>Present</th>
                <th>Absent</th>
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        const isLab = classTypeSelect.value === "Lab";
        const selectedLabSection = labSectionSelect.value;

        snapshot.forEach(doc => {
            const student = doc.data();
            const id = doc.id;
            const enroll = parseInt(student.enrollno);
            studentDataMap[id] = student;

            // ðŸ” Lab Section Filtering Logic
            if (isLab) {
                const inSectionA = enroll >= 234510331001 && enroll <= 234510331032;
                const inSectionB = enroll >= 234510331035 && enroll <= 234510331066;

                if ((selectedLabSection === "A" && !inSectionA) ||
                    (selectedLabSection === "B" && !inSectionB)) {
                    return; // Skip student not in selected lab section
                }
            }

            const row = document.createElement("tr");

            const enrollTd = document.createElement("td");
            enrollTd.textContent = student.enrollno || 'N/A';
            const nameTd = document.createElement("td");
            nameTd.textContent = student.name || 'N/A';

            const presentTd = document.createElement("td");
            const presentRadio = document.createElement("input");
            presentRadio.type = "radio";
            presentRadio.name = id;
            presentRadio.value = "Present";
            presentRadio.required = true;
            presentTd.appendChild(presentRadio);

            const absentTd = document.createElement("td");
            const absentRadio = document.createElement("input");
            absentRadio.type = "radio";
            absentRadio.name = id;
            absentRadio.value = "Absent";
            absentTd.appendChild(absentRadio);

            row.appendChild(enrollTd);
            row.appendChild(nameTd);
            row.appendChild(presentTd);
            row.appendChild(absentTd);
            tbody.appendChild(row);
        });

        table.appendChild(tbody);
        form.appendChild(table);

        console.log(`DEBUG Teacher: Loaded students (after lab filter): ${tbody.children.length}`);

        const selectedSubject = selectedSubjectInfo[0];
        const selectedType = selectedSubjectInfo[1];
        const selectedDate = attendanceDateInput.value;

        fetchAndPreFillAttendance(selectedSubject, selectedType, selectedDate);

    } catch (error) {
        console.error("DEBUG Teacher: Error fetching students:", error);
        showModal("Error", "Error fetching student data. Please check console for details.");
        const errorMessage = document.createElement("p");
        errorMessage.textContent = "Error fetching student data. Please check console for details.";
        form.appendChild(errorMessage);
    }
}

    // --- Function to Fetch and Pre-fill Existing Attendance ---
    async function fetchAndPreFillAttendance(subject, type, date) {
        console.log("DEBUG Teacher: Checking for existing attendance for:", { subject, type, date });
        try {
            // MODIFIED: Changed path to root-level 'attendance'
            const q = query(
                collection(db, "attendance"),
                where("subject", "==", subject),
                where("type", "==", type),
                where("date", "==", date)
                // No orderBy here as we'll iterate through all and match by studentId
            );
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                console.log("DEBUG Teacher: No existing attendance found for this selection.");
                return;
            }

            snapshot.forEach(doc => {
                const record = doc.data();
                const studentId = record.studentId;
                const status = record.status;

                const radioInput = document.querySelector(`input[name="${studentId}"][value="${status}"]`);
                if (radioInput) {
                    radioInput.checked = true;
                    console.log(`DEBUG Teacher: Pre-filled attendance for ${studentId} as ${status}.`);
                } else {
                    console.warn(`DEBUG Teacher: Could not find radio button for student ${studentId} with status ${status}.`);
                }
            });
            console.log("DEBUG Teacher: Existing attendance pre-filled.");

        } catch (error) {
            console.error("DEBUG Teacher: Error fetching existing attendance for pre-fill:", error);
        }
    }

    // --- Mark All Present/Absent Functions ---
    function markAllPresent() {
        const radios = attendanceForm.querySelectorAll('input[type="radio"][value="Present"]');
        radios.forEach(radio => {
            radio.checked = true;
        });
        showModal("Mark All", "All students marked 'Present'.");
    }

    function markAllAbsent() {
        const radios = attendanceForm.querySelectorAll('input[type="radio"][value="Absent"]');
        radios.forEach(radio => {
            radio.checked = true;
        });
        showModal("Mark All", "All students marked 'Absent'.");
    }

    // --- Function to Download Attendance (CSV) ---
    async function downloadAttendance() {
        const department = departmentSelect.value;
        const semester = semesterSelect.value;
        const selectedSubjectInfo = subjectSelect.value.split("__");
        const subject = selectedSubjectInfo[0];
        const type = selectedSubjectInfo[1];
        const date = attendanceDateInput.value;

        if (!department || !semester || !subject || !type || !date) {
            showModal("Selection Required", "Please select Department, Semester, Subject, Type, and Date to download attendance.");
            return;
        }

        console.log("DEBUG Teacher: Attempting to download attendance for:", { department, semester, subject, type, date });

        try {
            // MODIFIED: Changed path to root-level 'attendance'
            const q = query(
                collection(db, "attendance"),
                where("department", "==", department),
                where("semester", "==", semester),
                where("subject", "==", subject),
                where("type", "==", type),
                where("date", "==", date),
                orderBy("enrollno") // Order by enrollno for better formatting
            );

            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                showModal("No Records", "No attendance records found for the selected criteria.");
                console.log("DEBUG Teacher: No attendance records found for download query.");
                return;
            }

            let csvContent = "Enrollment Number,Student Name,Email,Status,Date,Subject,Type,Department,Semester\n";
            snapshot.forEach(doc => {
                const data = doc.data();
                // Use studentDataMap for name/email if loaded, otherwise fallback to stored data
                const studentName = studentDataMap[data.studentId]?.name || data.studentName || 'N/A'; // Added data.studentName fallback
                const studentEmail = studentDataMap[data.studentId]?.email || data.studentEmail || 'N/A'; // Added data.studentEmail fallback

                // Escape commas in studentName if any
                const escapedStudentName = studentName.includes(',') ? `"${studentName}"` : studentName;
                csvContent += `${data.enrollno},${escapedStudentName},${studentEmail},${data.status},${data.date},${data.type},${data.department},${data.semester}\n`; // Changed to data.type from data.subject
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection for download attribute
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `attendance_${department}_${semester}_${subject}_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                console.log("DEBUG Teacher: CSV download initiated successfully.");
            } else {
                showModal("Browser Limitation", "Your browser does not support direct file downloads. Please copy the data manually from console if needed.");
                console.warn("DEBUG Teacher: Browser does not support direct downloads.");
            }
        } catch (error) {
            console.error("DEBUG Teacher: Error downloading attendance:", error);
            showModal("Error", "Error generating attendance sheet: " + error.message);
        }
    }

    // --- Function to Submit Attendance ---
    async function submitAttendance() {
    const department = departmentSelect.value;
    const semester = semesterSelect.value;
    const selectedSubjectInfo = subjectSelect.value.split("__");
    const subject = selectedSubjectInfo[0];
    const type = selectedSubjectInfo[1];
    const time = selectedSubjectInfo[2];
    const date = attendanceDateInput.value;
    const labSection = classTypeSelect.value === "Lab" ? labSectionSelect.value : null;

    console.log("--- SUBMIT ATTENDANCE ATTEMPT ---");
    console.log("DEBUG Teacher: Selected:", { subject, type, date, department, semester, time, labSection });

    if (!subject || !type || !date || !department || !semester || !time) {
        showModal("Submission Error", "Please select Department, Semester, Subject, Type, and Date before submitting attendance.");
        console.log("DEBUG Teacher: Validation Failed: Missing required fields.");
        return;
    }

    const selectedDayName = new Date(date).toLocaleString('en-US', { weekday: 'long' });
    const isSubjectAssignedOnSelectedDay = weeklyAssignments.some(assignment =>
        assignment.subject === subject &&
        assignment.type === type &&
        assignment.days.includes(selectedDayName)
    );

    if (!isSubjectAssignedOnSelectedDay) {
        showModal("Submission Error", `The selected subject (${subject} - ${type}) is not assigned on ${selectedDayName}. Please choose a valid date or subject combination.`);
        console.log("DEBUG Teacher: Validation Failed: Subject not assigned on selected day.");
        return;
    }

    const studentRows = attendanceForm.querySelectorAll("tbody tr");
    if (studentRows.length === 0) {
        showModal("Submission Error", "No students loaded to submit attendance for. Please load students first.");
        console.log("DEBUG Teacher: Submission Failed: No students found in the form.");
        return;
    }

    const attendanceRecords = [];
    let allStudentsMarked = true;

    studentRows.forEach(row => {
        const studentId = row.querySelector('input[type="radio"]').name;
        const selectedStatus = document.querySelector(`input[name="${studentId}"]:checked`);

        if (!selectedStatus) {
            allStudentsMarked = false;
            return;
        }

        const studentData = studentDataMap[studentId];
        if (!studentData) {
            console.warn(`DEBUG Teacher: Student data not found in map for ID: ${studentId}`);
            return;
        }

        attendanceRecords.push({
            studentId,
            teacherId: currentTeacherId,
            department,
            semester,
            subject,
            type,
            date,
            time,
            status: selectedStatus.value,
            enrollno: studentData.enrollno || 'N/A',
            studentName: studentData.name || 'N/A',
            studentEmail: studentData.email || 'N/A',
            labSection: labSection // Include only if Lab, else null
        });
    });

    if (!allStudentsMarked) {
        showModal("Submission Error", "Please mark attendance (Present/Absent) for all students before submitting.");
        console.log("DEBUG Teacher: Submission Failed: Not all students marked.");
        return;
    }

    try {
        const batch = writeBatch(db);

        for (const record of attendanceRecords) {
            const attendanceDocId = `ATT_${record.date}_${record.subject.replace(/[^a-zA-Z0-9]/g, '')}_${record.type}_${record.time.replace(/[^a-zA-Z0-9]/g, '')}_${record.studentId}`;
            const attendanceRef = doc(db, "attendance", attendanceDocId);
            batch.set(attendanceRef, record, { merge: true });
        }

        await batch.commit();
        showModal("Success", "Attendance submitted successfully!");
        console.log("DEBUG Teacher: Attendance successfully submitted via batch write.");
        checkAndHighlightMissingAttendance();

    } catch (error) {
        console.error("DEBUG Teacher: Error submitting attendance:", error);
        showModal("Error", "Error submitting attendance: " + error.message);
    }
}


    // --- View Attendance Section Functions ---

    // Load all students for search in view attendance section
    async function loadAllStudents() {
        try {
            // MODIFIED: Changed path to root-level 'users'
            const q = query(
                collection(db, "users"),
                where("role", "==", "student"),
                orderBy("name")
            );
            const snapshot = await getDocs(q);
            allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log("DEBUG Teacher: Loaded all students for view section:", allStudents.length);
        } catch (error) {
            console.error("DEBUG Teacher: Error loading all students:", error);
        }
    }

    // Populate subject dropdown for the "View Attendance" section based on all assignments
    function populateViewSubjectDropdown() {
        const viewSubjectSelect = document.getElementById("viewSubject");
        viewSubjectSelect.innerHTML = '<option value="">All</option>'; // Always start with "All" option

        const uniqueSubjects = new Set();
        weeklyAssignments.forEach(assignment => {
            uniqueSubjects.add(assignment.subject);
        });

        Array.from(uniqueSubjects).sort().forEach(subject => {
            const option = document.createElement("option");
            option.value = subject;
            option.textContent = subject;
            viewSubjectSelect.appendChild(option);
        });
    }

    // Main function to view attendance records
    async function viewAttendance() {
        const viewDepartment = document.getElementById("viewDepartment").value;
        const viewSemester = document.getElementById("viewSemester").value;
        const viewSubject = document.getElementById("viewSubject").value;
        const viewType = document.getElementById("viewType").value;
        const viewStudentSearch = document.getElementById("viewStudentSearch").value.toLowerCase();
        const viewMonth = document.getElementById("viewMonth").value;
        const resultsDiv = document.getElementById("attendanceViewResults");
        resultsDiv.innerHTML = '<p>Loading attendance records...</p>';

        let baseQuery = collection(db, "attendance");
        let q = query(baseQuery);
        let filters = [];

        if (currentTeacherId) filters.push(where("teacherId", "==", currentTeacherId));
        if (viewDepartment) filters.push(where("department", "==", viewDepartment));
        if (viewSemester) filters.push(where("semester", "==", viewSemester));
        if (viewSubject) filters.push(where("subject", "==", viewSubject));
        if (viewType) filters.push(where("type", "==", viewType));

        if (filters.length > 0) q = query(baseQuery, ...filters);

        try {
            const snapshot = await getDocs(q);
            let records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            let filteredRecords = records.filter(record => {
                let matchesMonth = viewMonth ? record.date.startsWith(viewMonth) : true;
                let matchesStudent = viewStudentSearch ?
                    (record.studentName?.toLowerCase().includes(viewStudentSearch) ||
                        record.enrollno?.toLowerCase().includes(viewStudentSearch)) : true;
                return matchesMonth && matchesStudent;
            });

            filteredRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

            if (filteredRecords.length === 0) {
                resultsDiv.innerHTML = '<p>No attendance records found matching your criteria.</p>';
                return;
            }

            const table = document.createElement("table");
            const thead = document.createElement("thead");
            thead.innerHTML = `
            <tr>
                <th>Date</th><th>Subject</th><th>Type</th><th>Time</th>
                <th>Enroll No</th><th>Student Name</th><th>Status</th>
            </tr>`;
            table.appendChild(thead);

            const tbody = document.createElement("tbody");
            filteredRecords.forEach(record => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${record.date}</td>
                <td>${record.subject}</td>
                <td>${record.type}</td>
                <td>${record.time || 'N/A'}</td>
                <td>${record.enrollno || 'N/A'}</td>
                <td>${record.studentName || 'N/A'}</td>
                <td>
                    <select data-docid="${record.id}" data-current="${record.status}">
                        <option value="Present" ${record.status === "Present" ? "selected" : ""}>Present</option>
                        <option value="Absent" ${record.status === "Absent" ? "selected" : ""}>Absent</option>
                    </select>
                </td>`;
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(table);

            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save Changes";
            saveBtn.style.marginTop = "15px";
            saveBtn.style.backgroundColor = "#2ecc71";
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';

            saveBtn.addEventListener("click", async () => {
                const selects = resultsDiv.querySelectorAll("select");
                const updates = [...selects].filter(s => s.value !== s.dataset.current)
                    .map(s => ({ id: s.dataset.docid, newStatus: s.value }));

                if (updates.length === 0) {
                    showModal("No Changes", "No attendance status changed.");
                    return;
                }

                try {
                    const batch = writeBatch(db);
                    let successCount = 0;

                    for (const u of updates) {
                        const ref = doc(db, "attendance", u.id);
                        const snap = await getDoc(ref);

                        if (!snap.exists()) continue;

                        const data = snap.data();
                        if (data.teacherId === auth.currentUser.uid) {
                            batch.update(ref, { status: u.newStatus });
                            successCount++;
                        } else {
                            console.warn(`âš ï¸ Skip update: teacherId mismatch for doc ${u.id}`);
                        }
                    }

                    if (successCount === 0) {
                        showModal("Permission Denied", "No records were updated. You may not have permission to edit these.");
                        return;
                    }

                    await batch.commit();
                    showModal("Success", `${successCount} record(s) updated.`);
                    viewAttendance(); // refresh
                } catch (error) {
                    console.error("Update Error:", error);
                    showModal("Error", "Failed to update attendance records.");
                }
            });

            resultsDiv.appendChild(saveBtn);

        } catch (error) {
            console.error("DEBUG Teacher: Error viewing attendance:", error);
            showModal("Error", "Error loading attendance records: " + error.message);
            resultsDiv.innerHTML = '<p>Error loading attendance records.</p>';
        }
    }
    document.getElementById("attendanceDate").addEventListener("change", function () {
        const selectedDate = new Date(this.value);
        const dayName = selectedDate.toLocaleDateString("en-US", { weekday: "long" });

        if (dayName === "Sunday") {
            alert("Attendance cannot be marked on Sundays.");
            this.value = ""; // clear invalid selection
        }
    });
    document.getElementById("summaryStartDate").value
    document.getElementById("summaryEndDate").value
    document.getElementById("getSummaryBtn").addEventListener("click", async () => {
        const enrollNoString = document.getElementById("summaryEnrollNo")?.value.trim() || "";
        const startDateString = document.getElementById("summaryStartDate")?.value || ""; // "YYYY-MM-DD" format
        const endDateString = document.getElementById("summaryEndDate")?.value || "";   // "YYYY-MM-DD" format

        console.log("DEBUG: Enroll (input string):", enrollNoString, "Start (input string):", startDateString, "End (input string):", endDateString);

        if (!enrollNoString || !startDateString || !endDateString) {
            alert("Please fill all fields."); // Keeping alert for now, but custom message box is better
            return;
        }

        try {
            const attendanceRef = collection(db, "attendance");

            // 1. Convert enrollNo to a Number to match Firestore's stored type
            const enrollNoAsNumber = Number(enrollNoString);

            // Basic validation for the number conversion
            if (isNaN(enrollNoAsNumber)) {
                alert("Invalid Enrollment Number. Please enter a valid number.");
                return;
            }

            console.log("DEBUG: Querying with Enroll (as number):", enrollNoAsNumber, "Start (as string):", startDateString, "End (as string):", endDateString);

            const q = query(
                attendanceRef,
                where("enrollno", "==", enrollNoAsNumber), // Query with the NUMBER type
                where("date", ">=", startDateString),    // Query with the STRING type (YYYY-MM-DD)
                where("date", "<=", endDateString)       // Query with the STRING type (YYYY-MM-DD)
            );

            const snapshot = await getDocs(q);

            console.log("DEBUG: Firestore Query Executed. Snapshot size:", snapshot.size);

            if (snapshot.empty) {
                console.log("DEBUG: No matching documents found in Firestore for the given criteria.");
                // Update UI to show zeros if no data found
                document.getElementById("totalClasses").textContent = 0;
                document.getElementById("presentCount").textContent = 0;
                document.getElementById("absentCount").textContent = 0;
                document.getElementById("attendancePercent").textContent = "0.00%";
            } else {
                let total = 0;
                let present = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("DEBUG: Document ID:", doc.id, "Data:", data); // Log each document's data
                    total++;
                    // Ensure 'status' field exists and is "Present" (case-sensitive)
                    if (data.status === "Present") {
                        present++;
                    }
                });

                const absent = total - present;
                const percentage = total > 0 ? ((present / total) * 100).toFixed(2) : "0.00";

                document.getElementById("totalClasses").textContent = total;
                document.getElementById("presentCount").textContent = present;
                document.getElementById("absentCount").textContent = absent;
                document.getElementById("attendancePercent").textContent = percentage + "%";
            }
        } catch (err) {
            alert("Error fetching summary: " + err.message);
            console.error("Firebase Query Error:", err);
        }
    });

    document.getElementById("downloadCsv").addEventListener("click", async () => {
        try {
            const snapshot = await getDocs(collection(db, "attendance"));
            const attendanceData = {};
            const dateSet = new Set();

            snapshot.forEach(doc => {
                const data = doc.data();
                const key = `${data.enrollno} - ${data.studentName}`;
                if (!attendanceData[key]) attendanceData[key] = {};
                attendanceData[key][data.date] = data.status;
                dateSet.add(data.date);
            });

            const dates = Array.from(dateSet).sort();
            const headers = ["Enrollment No - Name", ...dates, "Total Present", "Percentage"];
            const rows = [headers];

            for (const student in attendanceData) {
                const row = [student];
                let presentCount = 0;

                dates.forEach(date => {
                    const status = attendanceData[student][date] || "Absent";
                    row.push(status);
                    if (status === "Present") presentCount++;
                });

                const percentage = ((presentCount / dates.length) * 100).toFixed(2) + "%";
                row.push(presentCount, percentage);
                rows.push(row);
            }

            const csv = rows.map(r => r.join(",")).join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "Attendance_Summary.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (err) {
            alert("Error generating attendance sheet: " + err.message);
            console.error(err);
        }
    });
    // Summary Feature

    // Edit Attendance Feature
    editSearchBtn.addEventListener("click", async () => {
        const enroll = document.getElementById("editEnroll").value.trim().toLowerCase();
        const start = document.getElementById("editStartDate").value;
        const end = document.getElementById("editEndDate").value;
        const resultsDiv = document.getElementById("editResults");
        resultsDiv.innerHTML = "";
        if (!enroll || !start || !end) return showModal("Input Error", "Please enter enroll number and both dates.");
        try {
            const q = query(collection(db, "attendance"), where("enrollno", "==", enroll));
            const snapshot = await getDocs(q);
            const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .filter(r => new Date(r.date) >= new Date(start) && new Date(r.date) <= new Date(end));
            if (records.length === 0) return resultsDiv.innerHTML = "<p>No records found.</p>";
            const table = document.createElement("table");
            table.innerHTML = `
      <thead><tr><th>Date</th><th>Subject</th><th>Type</th><th>Status</th><th>Change To</th></tr></thead>
      <tbody>
      ${records.map(r => `
        <tr>
          <td>${r.date}</td><td>${r.subject}</td><td>${r.type}</td><td>${r.status}</td>
          <td>
            <select data-docid="${r.id}" data-current="${r.status}">
              <option value="Present" ${r.status === "Present" ? "selected" : ""}>Present</option>
              <option value="Absent" ${r.status === "Absent" ? "selected" : ""}>Absent</option>
            </select>
          </td>
        </tr>
      `).join("")}
      </tbody>`;
            resultsDiv.appendChild(table);
            const updateBtn = document.createElement("button");
            updateBtn.innerHTML = '<i class="fas fa-save"></i> Update Attendance';
            updateBtn.style.marginTop = "15px";
            updateBtn.style.backgroundColor = "#2ecc71";
            updateBtn.addEventListener("click", async () => {
                const selects = resultsDiv.querySelectorAll("select");
                const updates = [...selects].filter(s => s.value !== s.dataset.current).map(s => ({ id: s.dataset.docid, newStatus: s.value }));
                if (updates.length === 0) return showModal("No Changes", "No attendance status changed.");
                try {
                    const batch = writeBatch(db);
                    updates.forEach(u => batch.update(doc(db, "attendance", u.id), { status: u.newStatus }));
                    await batch.commit();
                    showModal("Success", `${updates.length} record(s) updated.`);
                    resultsDiv.innerHTML = "";
                } catch (err) {
                    console.error("Update Error:", err);
                    showModal("Error", "Failed to update attendance records.");
                }
            });
            resultsDiv.appendChild(updateBtn);
        } catch (err) {
            console.error("Search Error:", err);
            showModal("Error", "Something went wrong while searching.");
        }
    });


    // --- Event Listeners ---
    departmentSelect.addEventListener("change", async () => {
        await loadAssignedSubjects();
        checkAndHighlightMissingAttendance();
    });
    semesterSelect.addEventListener("change", async () => {
        await loadAssignedSubjects();
        checkAndHighlightMissingAttendance();
    });

    // The subjectSelect change listener is crucial for updating the date picker and maybe other UI elements
    subjectSelect.addEventListener("change", updateDatePickerRestrictions);
    classTypeSelect.addEventListener("change", updateDatePickerRestrictions);
     classTypeSelect.addEventListener("change", () => {
    const isLab = classTypeSelect.value === "Lab";
    labSectionSelect.style.display = isLab ? "block" : "none";
    labSectionLabel.style.display = isLab ? "block" : "none";
  });
    attendanceDateInput.addEventListener("change", validateSelectedDateAgainstAssignments);

    document.getElementById("loadBtn").addEventListener("click", loadStudents);
    document.getElementById("submitBtn").addEventListener("click", submitAttendance);
    document.getElementById("downloadAttendanceBtn").addEventListener("click", downloadAttendance);

    document.getElementById("markAllPresentBtn").addEventListener("click", markAllPresent);
    document.getElementById("markAllAbsentBtn").addEventListener("click", markAllAbsent);

    // View Attendance Listeners
    document.getElementById("viewDepartment").addEventListener("change", populateViewSubjectDropdown); // Update subjects when dept changes
    document.getElementById("viewSemester").addEventListener("change", populateViewSubjectDropdown); // Update subjects when sem changes
    document.getElementById("viewAttendanceBtn").addEventListener("click", viewAttendance);

    // Modal close listeners
    document.getElementById("modalCloseButton").addEventListener("click", closeModal);
    document.getElementById("modalOkButton").addEventListener("click", closeModal);


    document.getElementById("logoutBtn").addEventListener("click", async () => {
        try {
            await signOut(auth);
            window.location.href = "index.html"; // Redirect to login page after logout
        } catch (error) {
            console.error("Error signing out:", error);
            showModal("Error", "Error signing out: " + error.message);
        }
    });
</script>
</body>

</html>
