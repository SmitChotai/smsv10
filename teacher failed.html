<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher - Mark Attendance</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        /* Teacher Dashboard Styles */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as requested */
            background-color: #f5f9fc;
            margin: 0;
            padding: 20px;
            color: #2c3e50;
            max-width: 1200px;
            margin: 0 auto;
            line-height: 1.6;
        }

        h2 {
            color: #1a5276;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 28px;
        }

        #teacherEmailDisplay {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 20px;
            font-weight: 500;
            color: #1a5276;
        }

        label {
            display: block;
            margin: 15px 0 8px 0;
            font-weight: 600;
            color: #2c3e50;
        }

        select,
        input[type="date"],
        input[type="text"] {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #d6eaf8;
            border-radius: 6px;
            background-color: white;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232980b9'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            appearance: none;
            padding-right: 40px;
        }

        select:focus,
        input[type="date"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 0;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); /* Added shadow */
        }

        button:hover {
            background-color: #1a5276;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.15); /* Increased shadow on hover */
        }

        #loadBtn {
            background-color: #27ae60;
            margin-top: 20px;
        }

        #loadBtn:hover {
            background-color: #219653;
        }

        #submitBtn {
            background-color: #2ecc71;
            margin-top: 30px;
            padding: 14px 24px;
            font-size: 17px;
        }

        #submitBtn:hover {
            background-color: #27ae60;
        }

        /* Attendance Form Styles */
        #attendanceForm {
            margin: 30px 0;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .attendance-actions button {
            padding: 10px 15px;
            font-size: 14px;
            box-shadow: none; /* Remove shadow for these smaller buttons */
        }
        .attendance-actions button:hover {
            transform: none; /* Remove transform for these smaller buttons */
            box-shadow: none;
        }


        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        th,
        td {
            padding: 14px 18px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        /* Logout Button */
        #logoutBtn {
            background-color: #e74c3c;
            margin-left: 15px;
        }

        #logoutBtn:hover {
            background-color: #c0392b;
        }

        /* Missing Attendance Section */
        #missingAttendanceSection {
            background-color: #fff3cd; /* Light yellow background */
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #missingAttendanceSection h3 {
            color: #856404; /* Darker yellow text */
            margin-top: 0;
            border-bottom: 1px solid #ffeeba;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        #missingAttendanceList {
            list-style: none;
            padding: 0;
        }

        #missingAttendanceList li {
            padding: 8px 0;
            border-bottom: 1px dashed #ffeec4;
            color: #856404;
        }

        #missingAttendanceList li:last-child {
            border-bottom: none;
        }

        /* Attendance View Section */
        #attendanceViewSection {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-top: 40px;
        }

        #attendanceViewSection h3 {
            color: #1a5276;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 24px;
        }

        #attendanceViewFilters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        #attendanceViewFilters > div {
            flex: 1 1 200px; /* Allow items to grow and shrink */
        }

        #attendanceViewResults table {
            margin-top: 20px;
        }

        /* Modal for messages instead of alert() */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .modal-header {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .modal-body {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .modal-footer {
            text-align: right;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }


        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            table, thead, tbody, th, td, tr {
                display: block;
            }

            /* Hide table headers (but not display: none;, for accessibility) */
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr { border: 1px solid #ccc; margin-bottom: 15px; }

            td {
                /* Behave like a "row" */
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50%;
                text-align: right;
            }

            td:before {
                /* Now like a table header */
                position: absolute;
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }

            /* Label the data */
            td:nth-of-type(1):before { content: "Enroll No"; }
            td:nth-of-type(2):before { content: "Name"; }
            td:nth-of-type(3):before { content: "Present"; }
            td:nth-of-type(4):before { content: "Absent"; }

            #attendanceViewFilters {
                flex-direction: column;
            }

            select,
            input[type="date"],
            input[type="text"] {
                max-width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="modalCloseButton">&times;</span>
            <div class="modal-header" id="modalHeader">Message</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button id="modalOkButton">OK</button>
            </div>
        </div>
    </div>

    <h2>Teacher Dashboard</h2>
    <p id="teacherEmailDisplay"></p>

    <label for="department">Department:</label>
    <select id="department">
        <option value="CSE">CSE</option>
        <option value="IT">IT</option>
        <option value="CE">CE</option>
    </select>

    <label for="semester">Semester:</label>
    <select id="semester">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
    </select>

    <label for="subjectSelect">Subject:</label>
    <select id="subjectSelect"></select>

    <label for="classType">Type:</label>
    <select id="classType">
        <option value="Lecture">Lecture</option>
        <option value="Lab">Lab</option>
    </select>

    <label for="attendanceDate">Date:</label>
    <input type="date" id="attendanceDate" />

    <button id="downloadAttendanceBtn" style="background-color: #3498db;"><i class="fas fa-download"></i> Download Attendance</button>
    <br><br>
    <button id="loadBtn"><i class="fas fa-users"></i> Load Students</button>

    <div id="missingAttendanceSection">
        <h3><i class="fas fa-exclamation-triangle"></i> Unmarked Classes for this Week</h3>
        <ul id="missingAttendanceList">
            <li>No missing attendance to show for selected criteria.</li>
        </ul>
    </div>

    <form id="attendanceForm">
        <div class="attendance-actions">
            <button type="button" id="markAllPresentBtn" style="background-color: #28a745;"><i class="fas fa-check-double"></i> Mark All Present</button>
            <button type="button" id="markAllAbsentBtn" style="background-color: #dc3545;"><i class="fas fa-times-circle"></i> Mark All Absent</button>
        </div>
    </form>

    <button id="submitBtn"><i class="fas fa-save"></i> Submit Attendance</button>

    <div id="attendanceViewSection">
        <h3><i class="fas fa-chart-bar"></i> View Attendance Records</h3>
        <div id="attendanceViewFilters">
            <div>
                <label for="viewDepartment">Department:</label>
                <select id="viewDepartment">
                    <option value="">All</option>
                    <option value="CSE">CSE</option>
                    <option value="IT">IT</option>
                    <option value="CE">CE</option>
                </select>
            </div>
            <div>
                <label for="viewSemester">Semester:</label>
                <select id="viewSemester">
                    <option value="">All</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                </select>
            </div>
            <div>
                <label for="viewSubject">Subject:</label>
                <select id="viewSubject">
                    <option value="">All</option>
                    <!-- Populated dynamically -->
                </select>
            </div>
            <div>
                <label for="viewType">Type:</label>
                <select id="viewType">
                    <option value="">All</option>
                    <option value="Lecture">Lecture</option>
                    <option value="Lab">Lab</option>
                </select>
            </div>
            <div>
                <label for="viewStudentSearch">Student Name/Enroll No:</label>
                <input type="text" id="viewStudentSearch" placeholder="Optional search">
            </div>
            <div>
                <label for="viewMonth">Month:</label>
                <input type="month" id="viewMonth">
            </div>
            <button id="viewAttendanceBtn" style="background-color: #007bff;"><i class="fas fa-search"></i> View Records</button>
        </div>
        <div id="attendanceViewResults">
            <!-- Attendance results table will be loaded here -->
            <p>Select filters and click "View Records" to see attendance.</p>
        </div>
    </div>


    <div style="display: flex; align-items: center; gap: 15px; margin-top: 20px;">
        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            setDoc,
            doc,
            orderBy,
            getDoc,
            writeBatch // Import writeBatch for efficient writes
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getAuth,
            onAuthStateChanged,
            signOut,
            signInWithCustomToken, // Ensure this is imported for Canvas setup
            signInAnonymously // Ensure this is imported for Canvas setup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Canvas Environment Variables ---
        // MANDATORY: Use __app_id, __firebase_config, __initial_auth_token
        // Note: These variables are provided by the Canvas environment.
        // The fallback is for local development where they might not be defined.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             // Fallback for local testing if __firebase_config is not defined
             apiKey: "AIzaSyBgXG-oIsLygIUwC4H5xUcduHqWa1Kba5w",
             authDomain: "studentattendancesystem-e3f6c.firebaseapp.com",
             projectId: "studentattendancesystem-e3f6c",
             storageBucket: "studentattendancesystem-e3f6c.appspot.com",
             messagingSenderId: "385675923275",
             appId: "1:385675923275:web:945301f83c5a7d182162ce",
             measurementId: "G-DM0VLMVNTM"
         };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables
        let currentTeacherId = null;
        const teacherEmailDisplay = document.getElementById("teacherEmailDisplay");
        const departmentSelect = document.getElementById("department");
        const semesterSelect = document.getElementById("semester");
        const subjectSelect = document.getElementById("subjectSelect");
        const attendanceDateInput = document.getElementById("attendanceDate");
        const classTypeSelect = document.getElementById("classType");
        const attendanceForm = document.getElementById("attendanceForm");

        let weeklyAssignments = []; // Stores all assignments for the current teacher, dept, sem for the week
        let studentDataMap = {}; // Stores student data fetched by loadStudents for easy lookup by ID
        let allStudents = []; // To store all students for the "View Attendance" student search dropdown

        // --- Modal Functions (Instead of alert()) ---
        function showModal(header, body) {
            document.getElementById('modalHeader').textContent = header;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('messageModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Attempt to sign in with custom token first (Canvas environment)
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("DEBUG Teacher: Signed in with custom token.");
                        // The onAuthStateChanged listener will re-fire with the authenticated user
                        return;
                    } catch (error) {
                        console.error("DEBUG Teacher: Error signing in with custom token:", error);
                        showModal("Authentication Error", "Failed to authenticate. Please log in again.");
                        window.location.href = "index.html"; // Redirect to login on error
                        return;
                    }
                } else {
                    // Fallback to anonymous sign-in for local development/testing without token
                    try {
                        await signInAnonymously(auth);
                        console.log("DEBUG Teacher: Signed in anonymously.");
                        // The onAuthStateChanged listener will re-fire with the authenticated user
                        return;
                    } catch (error) {
                        console.error("DEBUG Teacher: Error signing in anonymously:", error);
                        showModal("Authentication Error", "Failed to sign in anonymously. Please log in.");
                        window.location.href = "index.html";
                        return;
                    }
                }
            }

            // After successful authentication, check user role in Firestore
            // MODIFIED: Changed path to root-level 'users'
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists() || userDocSnap.data().role !== "teacher") {
                showModal("Access Denied", "You do not have teacher privileges.");
                await signOut(auth); // Sign out unauthorized user
                window.location.href = "index.html";
                return;
            }

            currentTeacherId = user.uid;
            teacherEmailDisplay.textContent = `Logged in as: ${user.email}`;

            // Load initial subjects based on current selections
            await loadAssignedSubjects();
            await loadAllStudents(); // Load all students for the view attendance section
            updateDatePickerRestrictions(); // Set date picker min/max based on assignments
            checkAndHighlightMissingAttendance(); // Check for missing attendance on load
            populateViewSubjectDropdown(); // Populate subject dropdown for viewing section
        });

        // --- Function to Load Assigned Subjects for the Teacher ---
        async function loadAssignedSubjects() {
            subjectSelect.innerHTML = ""; // Clear existing options
            const dept = departmentSelect.value;
            const sem = semesterSelect.value;

            console.log("DEBUG Teacher: Attempting to load subjects for:", { dept, sem, teacher: currentTeacherId });

            // MODIFIED: Changed path to root-level 'assignments'
            const q = query(collection(db, "assignments"),
                where("teacherId", "==", currentTeacherId),
                where("department", "==", dept),
                where("semester", "==", sem)
            );

            try {
                const snapshot = await getDocs(q);
                weeklyAssignments = []; // Reset weekly assignments array before populating

                if (snapshot.empty) {
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = `No subjects assigned for this selection.`;
                    subjectSelect.appendChild(option);
                    subjectSelect.disabled = true; // Disable subject selection if no assignments
                    console.log("DEBUG Teacher: No subjects found for current criteria.");
                    return;
                }

                subjectSelect.disabled = false; // Enable subject selection
                snapshot.forEach(doc => {
                    const data = doc.data();
                    weeklyAssignments.push(data); // Store all fetched assignments for date validation
                    const option = document.createElement("option");
                    // Combine subject, type, time, and assigned days into the option's value
                    option.value = `${data.subject}__${data.type}__${data.time}__${data.days.join(',')}`;
                    option.textContent = `${data.subject} (${data.type}) - ${data.time} (${data.days.join(', ')})`;
                    subjectSelect.appendChild(option);
                });
                console.log("DEBUG Teacher: Successfully fetched and processed assignments:", weeklyAssignments);

                // After loading subjects, always update date picker restrictions and check for missing attendance
                updateDatePickerRestrictions();
                checkAndHighlightMissingAttendance();
                populateViewSubjectDropdown(); // Update view subjects when assignments change
            } catch (error) {
                console.error("DEBUG Teacher: Detailed error loading assigned subjects:", error);
                subjectSelect.innerHTML = "<option value=''>Error loading subjects</option>";
                subjectSelect.disabled = true;
                showModal("Error", "Error loading subjects: " + error.message);
            }
        }

        // --- Date Utility Functions ---
        // Formats a Date object to "YYYY-MM-DD" string
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        // Gets a specific day (0=Sun, 1=Mon...6=Sat) in the week of a given date
        function getDayInWeek(date, dayIndex) {
            const d = new Date(date);
            const day = d.getDay(); // Current day of the week (0 for Sunday)
            const diff = d.getDate() - day + dayIndex;
            const result = new Date(d.setDate(diff));
            return new Date(result.setHours(0, 0, 0, 0)); // Normalize to start of day
        }

        // --- Date Picker Restrictions Logic ---
        function updateDatePickerRestrictions() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday

            let minDate, maxDate;

            if (dayOfWeek === 0) { // If today is Sunday
                // Allow marking for the previous week (Sunday to Saturday)
                minDate = getDayInWeek(today, 0); // Get Sunday of CURRENT week
                minDate.setDate(minDate.getDate() - 7); // Go back 7 days to get Sunday of PREVIOUS week

                maxDate = new Date(minDate);
                maxDate.setDate(minDate.getDate() + 6); // Add 6 days to get Saturday of PREVIOUS week
                console.log(`DEBUG Teacher: Date picker range: ${formatDate(minDate)} to ${formatDate(maxDate)} (Sunday Mode - Previous Week)`);
            } else { // If today is Monday-Saturday
                // Allow marking from Monday of the current week up to today
                minDate = getDayInWeek(today, 1); // Get Monday of CURRENT week
                maxDate = today; // Max date is today
                console.log(`DEBUG Teacher: Date picker range: ${formatDate(minDate)} to ${formatDate(maxDate)} (Weekday Mode - Current Week up to Today)`);
            }

            attendanceDateInput.min = formatDate(minDate);
            attendanceDateInput.max = formatDate(maxDate);

            // Always clear the selected date if it's no longer valid based on new restrictions
            if (attendanceDateInput.value) {
                const selectedDate = new Date(attendanceDateInput.value);
                selectedDate.setHours(0, 0, 0, 0);
                if (selectedDate < minDate || selectedDate > maxDate) {
                    attendanceDateInput.value = '';
                    console.log("DEBUG Teacher: Selected date cleared due to new restrictions.");
                }
            }

            // Add or re-add event listener to re-check date if user tries to pick invalid one
            attendanceDateInput.removeEventListener('change', validateSelectedDateAgainstAssignments);
            attendanceDateInput.addEventListener('change', validateSelectedDateAgainstAssignments);
        }

        // Validates the selected date against the assignments
        function validateSelectedDateAgainstAssignments() {
            const selectedDateStr = attendanceDateInput.value;
            if (selectedDateStr) {
                const selectedDate = new Date(selectedDateStr);
                const selectedDayName = selectedDate.toLocaleString('en-US', { weekday: 'long' });

                // Get selected subject and type from the dropdown
                const selectedSubjectInfo = subjectSelect.value.split("__");
                const currentSubject = selectedSubjectInfo[0];
                const currentType = selectedSubjectInfo[1];

                // Check if there are ANY assignments for the selected subject/type on the selected day
                const hasAssignmentOnSelectedDay = weeklyAssignments.some(assignment =>
                    assignment.subject === currentSubject &&
                    assignment.type === currentType &&
                    assignment.days.includes(selectedDayName)
                );

                if (!hasAssignmentOnSelectedDay) {
                    showModal("Invalid Date Selection", `No classes for ${currentSubject} (${currentType}) are assigned on ${selectedDayName}. Please select a day with assigned classes.`);
                    attendanceDateInput.value = ''; // Clear selection if invalid
                    console.log(`DEBUG Teacher: Invalid date (${selectedDayName}) selected: No assignments found for this day.`);
                }
            }
        }

        // --- Function to Check and Highlight Missing Attendance ---
        async function checkAndHighlightMissingAttendance() {
            const missingList = document.getElementById("missingAttendanceList");
            missingList.innerHTML = ''; // Clear previous list

            const dept = departmentSelect.value;
            const sem = semesterSelect.value;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, ..., 6 for Saturday

            let checkStartDate, checkEndDate;

            if (dayOfWeek === 0) { // If today is Sunday
                checkStartDate = getDayInWeek(today, 0);
                checkStartDate.setDate(checkStartDate.getDate() - 7); // Previous Sunday
                checkEndDate = new Date(checkStartDate);
                checkEndDate.setDate(checkStartDate.getDate() + 6); // Previous Saturday
            } else { // If Monday-Saturday
                checkStartDate = getDayInWeek(today, 1); // Current Monday
                checkEndDate = today;
            }

            console.log(`DEBUG Teacher: Checking for missing attendance from ${formatDate(checkStartDate)} to ${formatDate(checkEndDate)}.`);

            const scheduledClasses = [];
            weeklyAssignments.forEach(assignment => {
                for (let d = new Date(checkStartDate); d <= checkEndDate; d.setDate(d.getDate() + 1)) {
                    const dayName = d.toLocaleString('en-US', { weekday: 'long' });
                    if (assignment.days.includes(dayName)) {
                        scheduledClasses.push({
                            date: formatDate(d),
                            subject: assignment.subject,
                            type: assignment.type,
                            time: assignment.time,
                            dayName: dayName
                        });
                    }
                }
            });

            if (scheduledClasses.length === 0) {
                const li = document.createElement("li");
                li.textContent = "No classes scheduled for this period or selection.";
                missingList.appendChild(li);
                return;
            }

            // MODIFIED: Changed path to root-level 'attendance'
            const attendanceQuery = query(
                collection(db, "attendance"),
                where("teacherId", "==", currentTeacherId),
                where("department", "==", dept),
                where("semester", "==", sem),
            );

            const attendanceSnapshot = await getDocs(attendanceQuery);
            const markedAttendance = new Set(); // To store unique identifiers of marked classes

            attendanceSnapshot.forEach(docSnap => {
                const data = docSnap.data();
                const recordDate = new Date(data.date);
                recordDate.setHours(0,0,0,0);

                // Filter by date range in memory
                if (recordDate >= checkStartDate && recordDate <= checkEndDate) {
                    const identifier = `${data.date}__${data.subject}__${data.type}__${data.time}`;
                    markedAttendance.add(identifier);
                }
            });

            let foundMissing = false;
            scheduledClasses.forEach(scheduledClass => {
                const identifier = `${scheduledClass.date}__${scheduledClass.subject}__${scheduledClass.type}__${scheduledClass.time}`;
                if (!markedAttendance.has(identifier)) {
                    foundMissing = true;
                    const li = document.createElement("li");
                    li.innerHTML = `<strong>${scheduledClass.date} (${scheduledClass.dayName})</strong>: ${scheduledClass.subject} (${scheduledClass.type}) at ${scheduledClass.time} - <span style="color:red;">UNMARKED</span>`;
                    missingList.appendChild(li);
                }
            });

            if (!foundMissing) {
                const li = document.createElement("li");
                li.textContent = "All scheduled classes for this period have attendance marked!";
                missingList.appendChild(li);
            }
        }


        // --- Function to Load Students into the Form ---
        async function loadStudents() {
            const department = departmentSelect.value;
            const semester = semesterSelect.value;
            const form = document.getElementById("attendanceForm");
            form.innerHTML = `
                <div class="attendance-actions">
                    <button type="button" id="markAllPresentBtn" style="background-color: #28a745;"><i class="fas fa-check-double"></i> Mark All Present</button>
                    <button type="button" id="markAllAbsentBtn" style="background-color: #dc3545;"><i class="fas fa-times-circle"></i> Mark All Absent</button>
                </div>
            `; // Clear previous student list and re-add buttons

            // Re-attach listeners for new buttons
            document.getElementById("markAllPresentBtn").addEventListener("click", markAllPresent);
            document.getElementById("markAllAbsentBtn").addEventListener("click", markAllAbsent);


            // Pre-validation for loading students
            const selectedSubjectInfo = subjectSelect.value.split("__");
            if (!selectedSubjectInfo[0] || !attendanceDateInput.value) {
                showModal("Selection Required", "Please select a Subject and a Date before loading students.");
                console.log("DEBUG Teacher: Pre-validation failed: Subject or Date not selected.");
                return;
            }

            // Clear studentDataMap before loading new students
            studentDataMap = {}; // Reset the map

            console.log("DEBUG Teacher: Attempting to load students for Dept:", department, "Sem:", semester);

            try {
                // MODIFIED: Changed path to root-level 'users'
                const q = query(
                    collection(db, "users"),
                    where("role", "==", "student"),
                    where("department", "==", department),
                    where("semester", "==", semester),
                    orderBy("enrollno") // Ensure 'enrollno' field exists for all students and is indexed.
                );

                console.log("DEBUG Teacher: Firestore query for students:", q);
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    const noStudentsMessage = document.createElement("p");
                    noStudentsMessage.textContent = `No students found for selected department (${department}) & semester (${semester}).`;
                    form.appendChild(noStudentsMessage);
                    console.log("DEBUG Teacher: Student query snapshot is empty. No students found matching criteria.");
                    return;
                }

                // Create table structure
                const table = document.createElement("table");
                const thead = document.createElement("thead");
                thead.innerHTML = `
                    <tr>
                        <th>Enroll No</th>
                        <th>Name</th>
                        <th>Present</th>
                        <th>Absent</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement("tbody");

                snapshot.forEach(doc => {
                    const student = doc.data();
                    const id = doc.id; // The UID of the student
                    studentDataMap[id] = student; // Store full student data by UID

                    const row = document.createElement("tr");

                    const enrollTd = document.createElement("td");
                    enrollTd.textContent = student.enrollno || 'N/A'; // Handle missing enrollno gracefully
                    const nameTd = document.createElement("td");
                    nameTd.textContent = student.name || 'N/A'; // Handle missing name gracefully

                    const presentTd = document.createElement("td");
                    const presentRadio = document.createElement("input");
                    presentRadio.type = "radio";
                    presentRadio.name = id; // IMPORTANT: Use student ID as name for radio group
                    presentRadio.value = "Present";
                    presentRadio.required = true; // Makes sure at least one radio is selected for each student ID
                    presentTd.appendChild(presentRadio);

                    const absentTd = document.createElement("td");
                    const absentRadio = document.createElement("input");
                    absentRadio.type = "radio";
                    absentRadio.name = id; // IMPORTANT: Use student ID as name for radio group
                    absentRadio.value = "Absent";
                    absentTd.appendChild(absentRadio);

                    row.appendChild(enrollTd);
                    row.appendChild(nameTd);
                    row.appendChild(presentTd);
                    row.appendChild(absentTd);

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);
                form.appendChild(table);
                console.log(`DEBUG Teacher: Successfully loaded ${snapshot.docs.length} students.`);

                // Optional: Fetch and pre-fill existing attendance if it exists for the selected date/subject
                const selectedSubject = selectedSubjectInfo[0];
                const selectedType = selectedSubjectInfo[1];
                const selectedDate = attendanceDateInput.value;
                fetchAndPreFillAttendance(selectedSubject, selectedType, selectedDate);

            } catch (error) {
                console.error("DEBUG Teacher: Error fetching students:", error);
                showModal("Error", "Error fetching student data. Please check console for details.");
                const errorMessage = document.createElement("p");
                errorMessage.textContent = "Error fetching student data. Please check console for details.";
                form.appendChild(errorMessage);
            }
        }

        // --- Function to Fetch and Pre-fill Existing Attendance ---
        async function fetchAndPreFillAttendance(subject, type, date) {
            console.log("DEBUG Teacher: Checking for existing attendance for:", { subject, type, date });
            try {
                // MODIFIED: Changed path to root-level 'attendance'
                const q = query(
                    collection(db, "attendance"),
                    where("subject", "==", subject),
                    where("type", "==", type),
                    where("date", "==", date)
                    // No orderBy here as we'll iterate through all and match by studentId
                );
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    console.log("DEBUG Teacher: No existing attendance found for this selection.");
                    return;
                }

                snapshot.forEach(doc => {
                    const record = doc.data();
                    const studentId = record.studentId;
                    const status = record.status;

                    const radioInput = document.querySelector(`input[name="${studentId}"][value="${status}"]`);
                    if (radioInput) {
                        radioInput.checked = true;
                        console.log(`DEBUG Teacher: Pre-filled attendance for ${studentId} as ${status}.`);
                    } else {
                        console.warn(`DEBUG Teacher: Could not find radio button for student ${studentId} with status ${status}.`);
                    }
                });
                console.log("DEBUG Teacher: Existing attendance pre-filled.");

            } catch (error) {
                console.error("DEBUG Teacher: Error fetching existing attendance for pre-fill:", error);
            }
        }

        // --- Mark All Present/Absent Functions ---
        function markAllPresent() {
            const radios = attendanceForm.querySelectorAll('input[type="radio"][value="Present"]');
            radios.forEach(radio => {
                radio.checked = true;
            });
            showModal("Mark All", "All students marked 'Present'.");
        }

        function markAllAbsent() {
            const radios = attendanceForm.querySelectorAll('input[type="radio"][value="Absent"]');
            radios.forEach(radio => {
                radio.checked = true;
            });
            showModal("Mark All", "All students marked 'Absent'.");
        }

        // --- Function to Download Attendance (CSV) ---
        async function downloadAttendance() {
            const department = departmentSelect.value;
            const semester = semesterSelect.value;
            const selectedSubjectInfo = subjectSelect.value.split("__");
            const subject = selectedSubjectInfo[0];
            const type = selectedSubjectInfo[1];
            const date = attendanceDateInput.value;

            if (!department || !semester || !subject || !type || !date) {
                showModal("Selection Required", "Please select Department, Semester, Subject, Type, and Date to download attendance.");
                return;
            }

            console.log("DEBUG Teacher: Attempting to download attendance for:", { department, semester, subject, type, date });

            try {
                // MODIFIED: Changed path to root-level 'attendance'
                const q = query(
                    collection(db, "attendance"),
                    where("department", "==", department),
                    where("semester", "==", semester),
                    where("subject", "==", subject),
                    where("type", "==", type),
                    where("date", "==", date),
                    orderBy("enrollno") // Order by enrollno for better formatting
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showModal("No Records", "No attendance records found for the selected criteria.");
                    console.log("DEBUG Teacher: No attendance records found for download query.");
                    return;
                }

                let csvContent = "Enrollment Number,Student Name,Email,Status,Date,Subject,Type,Department,Semester\n";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Use studentDataMap for name/email if loaded, otherwise fallback to stored data
                    const studentName = studentDataMap[data.studentId]?.name || data.studentName || 'N/A'; // Added data.studentName fallback
                    const studentEmail = studentDataMap[data.studentId]?.email || data.studentEmail || 'N/A'; // Added data.studentEmail fallback

                    // Escape commas in studentName if any
                    const escapedStudentName = studentName.includes(',') ? `"${studentName}"` : studentName;
                    csvContent += `${data.enrollno},${escapedStudentName},${studentEmail},${data.status},${data.date},${data.type},${data.department},${data.semester}\n`; // Changed to data.type from data.subject
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) { // Feature detection for download attribute
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `attendance_${department}_${semester}_${subject}_${date}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    console.log("DEBUG Teacher: CSV download initiated successfully.");
                } else {
                    showModal("Browser Limitation", "Your browser does not support direct file downloads. Please copy the data manually from console if needed.");
                    console.warn("DEBUG Teacher: Browser does not support direct downloads.");
                }
            } catch (error) {
                console.error("DEBUG Teacher: Error downloading attendance:", error);
                showModal("Error", "Error generating attendance sheet: " + error.message);
            }
        }

        // --- Function to Submit Attendance ---
        async function submitAttendance() {
            const department = departmentSelect.value;
            const semester = semesterSelect.value;
            const selectedSubjectInfo = subjectSelect.value.split("__");
            const subject = selectedSubjectInfo[0];
            const type = selectedSubjectInfo[1];
            const time = selectedSubjectInfo[2]; // Get time from subject select value
            const date = attendanceDateInput.value; // Use attendanceDateInput.value directly

            console.log("--- SUBMIT ATTENDANCE ATTEMPT ---");
            console.log("DEBUG Teacher: Selected:", { subject, type, date, department, semester, time });

            // 1. Basic validation: Ensure all necessary inputs are selected
            if (!subject || !type || !date || !department || !semester || !time) {
                showModal("Submission Error", "Please select Department, Semester, Subject, Type, and Date before submitting attendance.");
                console.log("DEBUG Teacher: Validation Failed: Missing required fields.");
                return;
            }

            // 2. Validate if the selected date is an assigned day for this subject/type
            const selectedDayName = new Date(date).toLocaleString('en-US', { weekday: 'long' });
            const isSubjectAssignedOnSelectedDay = weeklyAssignments.some(assignment =>
                assignment.subject === subject &&
                assignment.type === type &&
                assignment.days.includes(selectedDayName)
            );

            if (!isSubjectAssignedOnSelectedDay) {
                showModal("Submission Error", `The selected subject (${subject} - ${type}) is not assigned on ${selectedDayName}. Please choose a valid date or subject combination.`);
                console.log("DEBUG Teacher: Validation Failed: Subject not assigned on selected day.");
                return;
            }

            // Get all student rows from the attendance form
            const studentRows = attendanceForm.querySelectorAll("tbody tr");
            if (studentRows.length === 0) {
                showModal("Submission Error", "No students loaded to submit attendance for. Please load students first.");
                console.log("DEBUG Teacher: Submission Failed: No students found in the form.");
                return;
            }

            const attendanceRecords = [];
            let allStudentsMarked = true;

            studentRows.forEach(row => {
                // The name attribute of the radio buttons is the student's UID
                const studentId = row.querySelector('input[type="radio"]').name;
                const selectedStatus = document.querySelector(`input[name="${studentId}"]:checked`);

                if (!selectedStatus) {
                    allStudentsMarked = false;
                    return; // Skip this student, allStudentsMarked will handle the overall alert
                }

                const studentData = studentDataMap[studentId]; // Get full student data from the map

                if (!studentData) {
                    console.warn(`DEBUG Teacher: Student data not found in map for ID: ${studentId}`);
                    // Potentially show a warning to the user or skip this student
                    return;
                }

                attendanceRecords.push({
                    studentId: studentId,
                    teacherId: currentTeacherId,
                    department: department,
                    semester: semester,
                    subject: subject,
                    type: type,
                    date: date,
                    time: time, // Include time for more specific attendance records
                    status: selectedStatus.value,
                    // Include student details for easier querying later if needed
                    enrollno: studentData.enrollno || 'N/A',
                    studentName: studentData.name || 'N/A',
                    studentEmail: studentData.email || 'N/A'
                });
            });

            if (!allStudentsMarked) {
                showModal("Submission Error", "Please mark attendance (Present/Absent) for all students before submitting.");
                console.log("DEBUG Teacher: Submission Failed: Not all students marked.");
                return;
            }

            try {
                // Use a batched write for efficiency when updating multiple documents
                const batch = writeBatch(db);

                for (const record of attendanceRecords) {
                    // Create a unique document ID for each attendance record to prevent duplicates
                    // Format: ATT_{date}_{subject_sanitized}_{type}_{studentId}
                    const attendanceDocId = `ATT_${record.date}_${record.subject.replace(/[^a-zA-Z0-9]/g, '')}_${record.type}_${record.time.replace(/[^a-zA-Z0-9]/g, '')}_${record.studentId}`;
                    // MODIFIED: Changed path to root-level 'attendance'
                    const attendanceRef = doc(db, "attendance", attendanceDocId);
                    batch.set(attendanceRef, record, { merge: true }); // merge: true to update existing records
                }

                await batch.commit();
                showModal("Success", "Attendance submitted successfully!");
                console.log("DEBUG Teacher: Attendance successfully submitted via batch write.");
                checkAndHighlightMissingAttendance(); // Re-check missing attendance after submission

            } catch (error) {
                console.error("DEBUG Teacher: Error submitting attendance:", error);
                showModal("Error", "Error submitting attendance: " + error.message);
            }
        }

        // --- View Attendance Section Functions ---

        // Load all students for search in view attendance section
        async function loadAllStudents() {
            try {
                // MODIFIED: Changed path to root-level 'users'
                const q = query(
                    collection(db, "users"),
                    where("role", "==", "student"),
                    orderBy("name")
                );
                const snapshot = await getDocs(q);
                allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("DEBUG Teacher: Loaded all students for view section:", allStudents.length);
            } catch (error) {
                console.error("DEBUG Teacher: Error loading all students:", error);
            }
        }

        // Populate subject dropdown for the "View Attendance" section based on all assignments
        function populateViewSubjectDropdown() {
            const viewSubjectSelect = document.getElementById("viewSubject");
            viewSubjectSelect.innerHTML = '<option value="">All</option>'; // Always start with "All" option

            const uniqueSubjects = new Set();
            weeklyAssignments.forEach(assignment => {
                uniqueSubjects.add(assignment.subject);
            });

            Array.from(uniqueSubjects).sort().forEach(subject => {
                const option = document.createElement("option");
                option.value = subject;
                option.textContent = subject;
                viewSubjectSelect.appendChild(option);
            });
        }

        // Main function to view attendance records
        async function viewAttendance() {
            const viewDepartment = document.getElementById("viewDepartment").value;
            const viewSemester = document.getElementById("viewSemester").value;
            const viewSubject = document.getElementById("viewSubject").value;
            const viewType = document.getElementById("viewType").value;
            const viewStudentSearch = document.getElementById("viewStudentSearch").value.toLowerCase();
            const viewMonth = document.getElementById("viewMonth").value; //YYYY-MM format

            const resultsDiv = document.getElementById("attendanceViewResults");
            resultsDiv.innerHTML = '<p>Loading attendance records...</p>';

            // MODIFIED: Changed path to root-level 'attendance'
            let baseQuery = collection(db, "attendance");
            let q = query(baseQuery);
            let filters = [];

            if (currentTeacherId) {
                filters.push(where("teacherId", "==", currentTeacherId));
            }
            if (viewDepartment) {
                filters.push(where("department", "==", viewDepartment));
            }
            if (viewSemester) {
                filters.push(where("semester", "==", viewSemester));
            }
            if (viewSubject) {
                filters.push(where("subject", "==", viewSubject));
            }
            if (viewType) {
                filters.push(where("type", "==", viewType));
            }

            // Apply all filters to the query
            if (filters.length > 0) {
                q = query(baseQuery, ...filters);
            }

            try {
                const snapshot = await getDocs(q);
                let records = [];
                snapshot.forEach(doc => records.push(doc.data()));

                // In-memory filtering for month and student search
                let filteredRecords = records.filter(record => {
                    let matchesMonth = true;
                    if (viewMonth) {
                        matchesMonth = record.date.startsWith(viewMonth);
                    }

                    let matchesStudent = true;
                    if (viewStudentSearch) {
                        const studentName = record.studentName ? record.studentName.toLowerCase() : '';
                        const enrollno = record.enrollno ? String(record.enrollno).toLowerCase() : '';
                        matchesStudent = studentName.includes(viewStudentSearch) || enrollno.includes(viewStudentSearch);
                    }
                    return matchesMonth && matchesStudent;
                });

                // Sort the filtered records (e.g., by date then student name)
                filteredRecords.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA.getTime() !== dateB.getTime()) {
                        return dateA.getTime() - dateB.getTime();
                    }
                    return a.studentName.localeCompare(b.studentName);
                });


                if (filteredRecords.length === 0) {
                    resultsDiv.innerHTML = '<p>No attendance records found matching your criteria.</p>';
                    return;
                }

                // Render results in a table
                const table = document.createElement("table");
                const thead = document.createElement("thead");
                thead.innerHTML = `
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Type</th>
                        <th>Time</th>
                        <th>Enroll No</th>
                        <th>Student Name</th>
                        <th>Status</th>
                    </tr>
                `;
                table.appendChild(thead);

                const tbody = document.createElement("tbody");
                filteredRecords.forEach(record => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.subject}</td>
                        <td>${record.type}</td>
                        <td>${record.time || 'N/A'}</td>
                        <td>${record.enrollno || 'N/A'}</td>
                        <td>${record.studentName || 'N/A'}</td>
                        <td>${record.status}</td>
                    `;
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                resultsDiv.innerHTML = ''; // Clear loading message
                resultsDiv.appendChild(table);

            } catch (error) {
                console.error("DEBUG Teacher: Error viewing attendance:", error);
                showModal("Error", "Error loading attendance records: " + error.message);
                resultsDiv.innerHTML = '<p>Error loading attendance records.</p>';
            }
        }


        // --- Event Listeners ---
        departmentSelect.addEventListener("change", async () => {
            await loadAssignedSubjects();
            checkAndHighlightMissingAttendance();
        });
        semesterSelect.addEventListener("change", async () => {
            await loadAssignedSubjects();
            checkAndHighlightMissingAttendance();
        });

        // The subjectSelect change listener is crucial for updating the date picker and maybe other UI elements
        subjectSelect.addEventListener("change", updateDatePickerRestrictions);
        classTypeSelect.addEventListener("change", updateDatePickerRestrictions);

        attendanceDateInput.addEventListener("change", validateSelectedDateAgainstAssignments);

        document.getElementById("loadBtn").addEventListener("click", loadStudents);
        document.getElementById("submitBtn").addEventListener("click", submitAttendance);
        document.getElementById("downloadAttendanceBtn").addEventListener("click", downloadAttendance);

        document.getElementById("markAllPresentBtn").addEventListener("click", markAllPresent);
        document.getElementById("markAllAbsentBtn").addEventListener("click", markAllAbsent);

        // View Attendance Listeners
        document.getElementById("viewDepartment").addEventListener("change", populateViewSubjectDropdown); // Update subjects when dept changes
        document.getElementById("viewSemester").addEventListener("change", populateViewSubjectDropdown); // Update subjects when sem changes
        document.getElementById("viewAttendanceBtn").addEventListener("click", viewAttendance);

        // Modal close listeners
        document.getElementById("modalCloseButton").addEventListener("click", closeModal);
        document.getElementById("modalOkButton").addEventListener("click", closeModal);


        document.getElementById("logoutBtn").addEventListener("click", async () => {
            try {
                await signOut(auth);
                window.location.href = "index.html"; // Redirect to login page after logout
            } catch (error) {
                console.error("Error signing out:", error);
                showModal("Error", "Error signing out: " + error.message);
            }
        });
    </script>

<!-- Lecture Count Section -->
<div id="lectureCountSection" style="margin-top: 40px;">
  <h3><i class="fas fa-calendar-check"></i> Total Lectures Count</h3>
  <label>Start Date:</label>
  <input type="date" id="lectureStartDate">
  <label>End Date:</label>
  <input type="date" id="lectureEndDate">
  <label>Enrollment No (optional):</label>
  <input type="text" id="lectureEnrollInput" placeholder="Enter Enroll No">
  <label>Subject:</label>
  <select id="lectureSubjectSelect">
    <option value="">All</option>
  </select>
  <button id="countLecturesBtn" style="background-color: #6c5ce7;"><i class="fas fa-calculator"></i> Count Lectures</button>
  <p id="lectureCountResult" style="margin-top: 15px; font-weight: bold;"></p>
</div>

<script type="module">
document.getElementById("countLecturesBtn").addEventListener("click", async () => {
    const startDate = document.getElementById("lectureStartDate").value;
    const endDate = document.getElementById("lectureEndDate").value;
    const enrollNo = document.getElementById("lectureEnrollInput").value.toLowerCase();
    const subject = document.getElementById("lectureSubjectSelect").value;

    if (!startDate || !endDate) {
        alert("Please select both Start and End dates.");
        return;
    }

    const db = window.db;
    const currentTeacherId = window.currentTeacherId;

    const attendanceRef = collection(db, "attendance");
    let q = query(attendanceRef, where("teacherId", "==", currentTeacherId));
    if (subject) q = query(q, where("subject", "==", subject));

    try {
        const snapshot = await getDocs(q);
        const filtered = snapshot.docs.map(doc => doc.data()).filter(record => {
            const date = record.date;
            return date >= startDate && date <= endDate &&
                (!enrollNo || (record.enrollno && record.enrollno.toLowerCase().includes(enrollNo)));
        });

        const lectureSet = new Set(
            filtered.map(r => `${r.date}__${r.subject}__${r.type}__${r.time}`)
        );
        const totalLectures = lectureSet.size;

        document.getElementById("lectureCountResult").textContent = `Total Lectures: ${totalLectures}`;
    } catch (err) {
        console.error("Count Error:", err);
        alert("Failed to count lectures.");
    }
});
</script>

</body>

</html>
